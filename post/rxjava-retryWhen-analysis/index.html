
<!DOCTYPE html>
<html>
  <head>
    
<meta charset="utf-8" >

<title>RxJava 2 | retryWhen æ“ä½œç¬¦æºç åˆ†æ | Melody</title>
<meta name="description" content="Keep Alive.">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://www.imhanjie.com//favicon.ico?v=1570610771688">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://www.imhanjie.com//styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



  </head>
  <body>
    <div id="app" class="main">
      <div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://www.imhanjie.com/">
        <img class="avatar" src="https://www.imhanjie.com//images/avatar.png?v=1570610771688" alt="" width="32px" height="32px">
      </a>
      <a href="https://www.imhanjie.com/">
        <h1 class="site-title">Melody</h1>
      </a>
    </div>
    <div class="right">
      <transition name="fade">
        <i class="icon" :class="{ 'icon-close-outline': menuVisible, 'icon-menu-outline': !menuVisible }" @click="menuVisible = !menuVisible"></i>
      </transition>
    </div>
  </div>
</div>

<transition name="fade">
  <div class="menu-container" style="display: none;" v-show="menuVisible">
    <div class="menu-list">
      
        
          <a href="/" class="menu purple-link">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="menu purple-link">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="menu purple-link">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="menu purple-link">
            å…³äº
          </a>
        
      
    </div>
  </div>
</transition>


      <div class="content-container">
        <div class="post-detail">
          
          <h2 class="post-title">RxJava 2 | retryWhen æ“ä½œç¬¦æºç åˆ†æ</h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> 2019-07-18</span>
            
              <span>
                <i class="icon-pricetags-outline"></i>
                
                  <a href="https://www.imhanjie.com//tag/android">
                    Android
                    
                  </a>
                
              </span>
            
          </div>
          <div class="post-content">
            <!--more-->
<h3 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h3>
<p><code>retryWhen</code> æ“ä½œç¬¦çš„ä½œç”¨æ˜¯åœ¨ä¸Šæ¸¸å‘å°„äº†ä¸€ä¸ªé”™è¯¯äº‹ä»¶æ—¶ï¼Œå¯ä»¥æ ¹æ®æ¡ä»¶è‡ªå·±å†³å®šæ˜¯å¦è¿›è¡Œé‡è¯•ï¼Œè®©ä¸Šæ¸¸é‡æ–°å‘é€äº‹ä»¶ã€‚åœ¨å¼€å‘ä¸­ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ“ä½œç¬¦ï¼Œä¾‹å¦‚å®ƒå¯ä»¥ç”¨æ¥åœ¨ç½‘ç»œè¯·æ±‚å¤±è´¥æ—¶è¦æ±‚å…¶è¿›è¡Œé‡è¯•ï¼Œé‡æ–°å»è¿›è¡Œç½‘ç»œè¯·æ±‚ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä½¿ç”¨æ¡ˆä¾‹ï¼š</p>
<pre><code class="language-java">Observable
        .create((ObservableOnSubscribe&lt;String&gt;) e -&gt; {
            e.onNext(&quot;A&quot;);
            e.onNext(&quot;B&quot;);
            e.onError(new RuntimeException(&quot;always on error!&quot;));
            e.onNext(&quot;C&quot;);
            e.onComplete();
        })
        .retryWhen(attempts -&gt; {
            System.out.println(&quot;retryWhen: apply()&quot;);
            return attempts.flatMap(throwable -&gt; {
                System.out.println(&quot;attempts: flatMap apply() -&gt; &quot; + throwable);
                return Observable.just(&quot;just retry!&quot;);
            });
        })
        .subscribe(new Observer&lt;String&gt;() {
            @Override
            public void onSubscribe(Disposable d) {
                System.out.println(&quot;onSubscribe()&quot;);
            }

            @Override
            public void onNext(String s) {
                System.out.println(&quot;onNext(): &quot; + s);
            }

            @Override
            public void onError(Throwable e) {
                System.out.println(&quot;onError(): &quot; + e);
            }

            @Override
            public void onComplete() {
                System.out.println(&quot;onComplete()&quot;);
            }
        });
</code></pre>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code>retryWhen: apply()
onSubscribe()
onNext(): A
onNext(): B
attempts: flatMap apply() -&gt; java.lang.RuntimeException: always on error!
onNext(): A
onNext(): B
attempts: flatMap apply() -&gt; java.lang.RuntimeException: always on error!
onNext(): A
onNext(): B
attempts: flatMap apply() -&gt; java.lang.RuntimeException: always on error!
...
</code></pre>
<p>å¦‚æœå°†ä»¥ä¸Šä»£ç ä¸­çš„ï¼š</p>
<pre><code class="language-java">return Observable.just(&quot;just retry!&quot;);
</code></pre>
<p>æ›´æ”¹ä¸ºä¸‹é¢è¿™æ ·ï¼š</p>
<pre><code class="language-java">return Observable.error(new RuntimeException(&quot;shutdown!&quot;))
</code></pre>
<p>å†çœ‹è¾“å‡ºç»“æœï¼š</p>
<pre><code>retryWhen: apply()
onSubscribe()
onNext(): A
onNext(): B
attempts: flatMap apply()
onError(): java.lang.RuntimeException: shutdown!
</code></pre>
<p>ä¸ºäº†ä¸‹é¢ç†è§£æ–¹ä¾¿ï¼Œå°†ä¸Šé¢çš„ä»£ç æ”¹å†™æˆä¸‹é¢ ğŸ‘‡ è¿™æ ·ï¼Œä»£ç é€»è¾‘ä¸€æ¨¡ä¸€æ ·ï¼Œåªæ˜¯ä¸ä½¿ç”¨é“¾å¼è°ƒç”¨å¹¶ä¸”å»æ‰äº† <code>retryWhen</code> çš„ lambda è¡¨è¾¾å¼ï¼Œæ‹†åˆ†å‡ºä¸Šæ¸¸ <code>upStream</code> å’Œä¸‹æ¸¸ <code>downStream</code> çš„æ¦‚å¿µï¼š</p>
<pre><code class="language-java">// ä¸Šæ¸¸
Observable&lt;String&gt; upStream = Observable.create(e -&gt; {
    e.onNext(&quot;A&quot;);
    e.onNext(&quot;B&quot;);
    e.onError(new RuntimeException(&quot;always on error!&quot;));
    e.onNext(&quot;C&quot;);
    e.onComplete();
});

// ä¸‹æ¸¸
Observer&lt;String&gt; downStream = new Observer&lt;String&gt;() {
    @Override
    public void onSubscribe(Disposable d) {
        System.out.println(&quot;onSubscribe()&quot;);
    }

    @Override
    public void onNext(String s) {
        System.out.println(&quot;onNext(): &quot; + s);
    }

    @Override
    public void onError(Throwable e) {
        System.out.println(&quot;onError(): &quot; + e);
    }

    @Override
    public void onComplete() {
        System.out.println(&quot;onComplete()&quot;);
    }
};

// retryWhen
upStream.retryWhen(new Function&lt;Observable&lt;Throwable&gt;, ObservableSource&lt;?&gt;&gt;() {
    @Override
    public ObservableSource&lt;?&gt; apply(Observable&lt;Throwable&gt; attempts) throws Exception {
        System.out.println(&quot;retryWhen: apply()&quot;);
        return attempts.flatMap(throwable -&gt; {
            System.out.println(&quot;attempts: flatMap apply() -&gt; &quot; + throwable);
            Thread.sleep(1000);
            return Observable.just(&quot;just retry&quot;);
        });
    }
}).subscribe(downStream);
</code></pre>
<p>ä»¥ä¸Šå°±æ˜¯ <code>retryWhen</code> æ“ä½œç¬¦çš„åŸºæœ¬ä½¿ç”¨ï¼Œå¦‚æœåœ¨ <code>retryWhen</code> ä¸­ <code>return</code> è¿”å›çš„æµå‘å°„äº†ï¼š</p>
<ul>
<li>ä¸€ä¸ªæ­£å¸¸äº‹ä»¶ï¼Œå³ä»£è¡¨é‡è¯•ï¼Œä¼šé‡æ–°å‘å°„ä¸Šæ¸¸çš„äº‹ä»¶ã€‚</li>
<li>ä¸€ä¸ªé”™è¯¯äº‹ä»¶ï¼Œå³ä»£è¡¨ä¸æƒ³é‡è¯•ï¼Œä¼šç«‹å³è°ƒç”¨ä¸‹æ¸¸çš„ <code>onError()</code> æ–¹æ³•ï¼Œå¹¶ä¸”ä¼šå°†è¿™ä¸ªé”™è¯¯äº‹ä»¶ä¸­çš„å¼‚å¸¸ä¿¡æ¯ä½œä¸ºå‚æ•°ä¼ è¿‡å»ã€‚</li>
</ul>
<p>ä»ä¸Šé¢çš„è¾“å‡ºè¿˜å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼Œ<code>retryWhen</code> çš„ <code>Function</code> çš„ <code>apply()</code> æ–¹æ³•<strong>åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡</strong>ï¼Œå¹¶ä¸”æ˜¯åœ¨ä¸‹æ¸¸ <code>onSubscribe()</code>  æ–¹æ³•ä¹‹å‰è°ƒç”¨ï¼Œ<strong>å¹¶ä¸æ˜¯åœ¨æ¯æ¬¡ä¸Šæ¸¸å‡ºé”™éƒ½ä¼šå»è°ƒç”¨</strong>ã€‚</p>
<p>åœ¨ <code>retryWhen</code> çš„ <code>Function</code> çš„ <code>apply()</code> æ–¹æ³•ä¸­æœ‰ä¸€ä¸ª <code>Observable&lt;Throwable&gt; attempts</code> å‚æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæµï¼Œæ˜¯ <code>retryWhen</code> æ“ä½œç¬¦å†…éƒ¨ ( å‡†ç¡®çš„æ˜¯ <code>ObservableRetryWhen</code> å†… ) çš„ä¸€ä¸ªæµï¼Œå½“ä¸Šæ¸¸å‡ºé”™æ—¶ï¼Œè™½ç„¶ <code>retryWhen</code> çš„ <code>Function</code> çš„ <code>apply()</code> æ–¹æ³•ä¸ä¼šè¢«è°ƒç”¨ï¼Œä½†æ˜¯ä¼šå°†æ¯æ¬¡é”™è¯¯ä¿¡æ¯ä» <code>attempts</code> ä¸­å‘å°„å‡ºå»ï¼Œæ‰€ä»¥ä¸Šæ¸¸æ¯å‡ºç°é”™è¯¯æ—¶ï¼Œ<code>attempts</code> å°±ä¼šå‘å°„ä¸€æ¬¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ ¹æ® <code>attempts</code> çš„é”™è¯¯ä¿¡æ¯æ¥å†³å®šæ˜¯å¦é‡è¯•ã€‚</p>
<p>ä»¥ä¸Šç»“è®ºä¼šåœ¨ä¸‹é¢æºç åˆ†æä¸­å¾—åˆ°è®ºè¯ã€‚</p>
<h3 id="æµç¨‹åˆ†æ">æµç¨‹åˆ†æ</h3>
<p>é¦–å…ˆçœ‹ <code>create()</code> ï¼š</p>
<pre><code class="language-java">public static &lt;T&gt; Observable&lt;T&gt; create(ObservableOnSubscribe&lt;T&gt; source) {
    ObjectHelper.requireNonNull(source, &quot;source is null&quot;);
    return RxJavaPlugins.onAssembly(new ObservableCreate&lt;T&gt;(source));
}
</code></pre>
<p>ä¾‹å­ä¸­åˆ›å»ºä¸Šæ¸¸æ—¶ä½¿ç”¨çš„æ˜¯ <code>create()</code> æ“ä½œç¬¦ï¼Œæ­¤æ—¶æµ <code>Observable</code> çš„å®é™…ç±»å‹ä¸º <code>ObservableCreate</code> ï¼Œç„¶åç»è¿‡  <code>retryWhen</code> ï¼š</p>
<pre><code class="language-java">public final Observable&lt;T&gt; retryWhen(
    final Function&lt;? super Observable&lt;Throwable&gt;, ? extends ObservableSource&lt;?&gt;&gt; handler) {
    ObjectHelper.requireNonNull(handler, &quot;handler is null&quot;);
    return RxJavaPlugins.onAssembly(new ObservableRetryWhen&lt;T&gt;(this, handler));
}
</code></pre>
<p>ç»è¿‡ <code>retryWhen</code> æ“ä½œç¬¦åï¼Œæµçš„ç±»å‹å˜ä¸º <code>ObservableRetryWhen</code> ï¼Œç„¶åä¸‹æ¸¸è®¢é˜…ä¸Šæ¸¸è°ƒç”¨ <code>subscribe()</code> æ—¶ï¼Œè°ƒç”¨çš„æ˜¯ <code>ObservableRetryWhen</code> çš„ <code>subscribe()</code> æ–¹æ³•ï¼Œå†…éƒ¨ä¼šæœ€ç»ˆè°ƒç”¨å…¶ <code>subscribeActual()</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-java">@Override
protected void subscribeActual(Observer&lt;? super T&gt; observer) {
  	// ä¿¡å·æºï¼Œå³ä¸Šæ–‡ä¸­æåˆ°çš„ attempts
    Subject&lt;Throwable&gt; signaller = PublishSubject.&lt;Throwable&gt;create().toSerialized();
		
    ObservableSource&lt;?&gt; other;

    try {
      	// æ‰€ä»¥ other å°±æ˜¯æˆ‘ä»¬åœ¨ retryWhen é‡Œé¢è¿”å›çš„é‚£ä¸ªæµï¼Œå³ Observable.just(&quot;just retry!&quot;)
        other = ObjectHelper.requireNonNull(handler.apply(signaller), &quot;The handler returned a null ObservableSource&quot;);
    } catch (Throwable ex) {
        Exceptions.throwIfFatal(ex);
        EmptyDisposable.error(ex, observer);
        return;
    }

    RepeatWhenObserver&lt;T&gt; parent = new RepeatWhenObserver&lt;T&gt;(observer, signaller, source);
    observer.onSubscribe(parent);

    other.subscribe(parent.inner);

    parent.subscribeNext();
}
</code></pre>
<h4 id="signaller">signaller</h4>
<p>åœ¨ <code>ObservableRetryWhen</code> è¢«è®¢é˜…æ—¶é¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ªä¿¡å·æº <code>signaller</code>ï¼Œå³ä¸Šæ–‡ä¸­æåˆ°çš„ <code>attempts</code> ï¼Œç”¨æ¥å‘å°„ä¸Šæ¸¸å‡ºç°çš„é”™è¯¯ã€‚</p>
<h4 id="other">other</h4>
<pre><code class="language-java">other = ObjectHelper.requireNonNull(handler.apply(signaller)
</code></pre>
<p><code>handler</code> å°±æ˜¯ <code>retryWhen</code> çš„å‚æ•° <code>Function</code> ï¼Œå¯ä»¥çœ‹åˆ°åœ¨è°ƒç”¨ <code>Function</code> çš„ <code>apply()</code> å‡½æ•°æ—¶å°† <code>signaller</code> ä½œä¸ºå‚æ•° ä¼ è¿‡å»äº†ï¼Œå°±æ˜¯åˆšåˆšå¤–é¢æåˆ°çš„ <code>attempts</code> å‚æ•°ï¼Œæ‰€ä»¥ <code>other</code> å°±æ˜¯ <code>Function</code> çš„è¿”å›å€¼ï¼Œå³ä½¿ç”¨ <code>retryWhen</code> æ“ä½œç¬¦è¿”å›çš„é‚£ä¸ªæµï¼š</p>
<pre><code class="language-java">Observable.just(&quot;just retry!&quot;)
</code></pre>
<h4 id="repeatwhenobserver">RepeatWhenObserver</h4>
<p><code>RepeatWhenObserver</code> åœ¨ <code>ObservableRetryWhen</code> å†…éƒ¨å°†åŸå§‹çš„ä¸Šæ¸¸ <code>source</code> ( <code>upstream</code> ) ä»¥åŠåŸå§‹çš„ä¸‹æ¸¸ <code>observer</code> ( <code>downstream</code> ) å°è£…èµ·æ¥ï¼Œé€šè¿‡å…¶å˜é‡å <code>parent</code> ä¹Ÿå¯ä»¥çœ‹å‡ºå…¶ä»£è¡¨çš„æ„æ€ä¸º <code>retryWhen</code> æ“ä½œç¬¦çš„ä¸Šæ¸¸ã€‚</p>
<h4 id="è®¢é˜…å…³ç³»">è®¢é˜…å…³ç³»</h4>
<pre><code class="language-java">other.subscribe(parent.inner);
</code></pre>
<p><code>parent.inner</code> å³ <code>RepeatWhenObserver</code> çš„å†…éƒ¨ç±» <code>InnerRepeatObserver</code> è®¢é˜…äº†æˆ‘ä»¬è¿”å›çš„æµã€‚ä¸‹é¢ä¼šæåˆ°ï¼Œè¿™é‡Œåªéœ€è¦çŸ¥é“ <code>parent.inner</code> è®¢é˜…äº†æˆ‘ä»¬è¿”å›çš„ <code>Observable.just(&quot;just retry!&quot;)</code> å³å¯ã€‚</p>
<pre><code class="language-java">parent.subscribeNext();
</code></pre>
<p>å†çœ‹ <code>RepeatWhenObserver</code> çš„ <code>subscribeNext()</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-java">void subscribeNext() {
    if (wip.getAndIncrement() == 0) {

        do {
            if (isDisposed()) {
                return;
            }

            if (!active) {
                active = true;
                source.subscribe(this);
            }
        } while (wip.decrementAndGet() != 0);
    }
}
</code></pre>
<p>å†…éƒ¨ä¼šè®© <code>RepeatWhenObserver</code> è‡ªå·±è®¢é˜…æˆ‘ä»¬çš„åŸå§‹ä¸Šæ¸¸ <code>source</code> ( <code>upstream</code> ) ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">è¢«è§‚å¯Ÿè€…</th>
<th>è§‚å¯Ÿè€…</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>upstream ( åŸå§‹æµ )</strong></td>
<td><strong>RepeatWhenObserver</strong></td>
</tr>
<tr>
<td style="text-align:left"><strong>other ( retryWhen ä¸­æˆ‘ä»¬è¿”å›çš„æµ )</strong></td>
<td><strong>InnerRepeatObserver</strong></td>
</tr>
</tbody>
</table>
<h4 id="é‡è¯•æœºåˆ¶">é‡è¯•æœºåˆ¶</h4>
<p>åœ¨å°†é‡è¯•æœºåˆ¶ä¹‹å‰ï¼Œä¼šå…ˆåˆ†ææ­£å¸¸çš„æµç¨‹ï¼Œå³ä¸Šæ¸¸ä¸ä¼šæŠ›å‡ºé”™è¯¯ä¸é‡è¯•çš„æµç¨‹ï¼Œç„¶åå†åˆ†æé”™è¯¯é‡è¯•çš„æµç¨‹ï¼Œå³ä¸Šæ¸¸å‘å°„é”™è¯¯äº‹ä»¶è§¦å‘é‡è¯•çš„æµç¨‹ã€‚</p>
<h5 id="æ­£å¸¸ä¸é‡è¯•æµç¨‹">æ­£å¸¸ä¸é‡è¯•æµç¨‹</h5>
<p>è¿˜æ˜¯æŒ‰ç…§ä¸Šé¢çš„ä¾‹å­ï¼Œä¸Šæ¸¸ <code>upstream</code> é¦–å…ˆå‘å°„ <code>A</code> ï¼Œç”±è®¢é˜…å…³ç³»å¾—çŸ¥ä¼šè§¦å‘ <code>RepeatWhenObserver</code> çš„ <code>onNext()</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-java">@Override
public void onNext(T t) {
    HalfSerializer.onNext(downstream, t, this, error);
}
</code></pre>
<pre><code class="language-java">public static &lt;T&gt; void onNext(Observer&lt;? super T&gt; observer, T value,
        AtomicInteger wip, AtomicThrowable error) {
    if (wip.get() == 0 &amp;&amp; wip.compareAndSet(0, 1)) {
        observer.onNext(value);
        ...
    }
}
</code></pre>
<p>æ­¤å¤„çš„ <code>observer</code> å°±æ˜¯çœŸæ­£çš„ä¸‹æ¸¸ <code>downstream</code>ã€‚å¯ä»¥çœ‹åˆ°å†…éƒ¨ä¼šè°ƒç”¨ <code>downstream</code> çš„ <code>onNext()</code> æ–¹æ³•ï¼Œå®Œæˆè½¬å‘æ“ä½œã€‚</p>
<h5 id="é”™è¯¯é‡è¯•æµç¨‹">é”™è¯¯é‡è¯•æµç¨‹</h5>
<p>æŒ‰ç…§ä¸Šé¢çš„ä¾‹å­ï¼Œä¸Šæ¸¸ <code>upstream</code> æ¨¡æ‹Ÿå‡ºé”™ä¼šå‘å°„ <code>RuntimeException(&quot;always on error!&quot;)</code> äº‹ä»¶ï¼Œç”±è®¢é˜…å…³ç³»å¾—çŸ¥ä¼šè§¦å‘ <code>RepeatWhenObserver</code> çš„ <code>onError()</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-java">@Override
public void onError(Throwable e) {
    DisposableHelper.replace(upstream, null);
    active = false;
    signaller.onNext(e);
}
</code></pre>
<p>å¾ˆæ˜æ˜¾ï¼Œåœ¨è¿™é‡Œæ‹¿åˆ°ä¸Šæ¸¸çš„å¼‚å¸¸ä¿¡æ¯åï¼Œå°†å¼‚å¸¸ä¿¡æ¯é€šè¿‡ <code>signaller</code> æµå‘å°„äº†å‡ºå»ã€‚<code>signaller</code> å³ <code>retryWhen</code> å‚æ•° <code>Function</code> ä¸­ <code>apply()</code> æ–¹æ³•çš„å‚æ•° <code>attempts</code> ã€‚</p>
<p>è¿™é‡Œå…ˆä¸å¿…æ¢ç©¶è°ä¼šè®¢é˜… <code>signaller</code> æµï¼Œæˆ‘ä»¬å…ˆçœ‹ <code>other</code> å‚æ•°ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨ <code>retryWhen</code> ä¸­è¿”å›çš„æµï¼Œå®ƒæ˜¯è¢« <code>InnerRepeatObserver</code> æ‰€è®¢é˜…ç€çš„ï¼Œå¦‚æœæˆ‘ä»¬è¿”å›çš„æµ <code>other</code> å‘å°„äº†ä¸€ä¸ªæ­£å¸¸æ—¶é—´ï¼Œæ¥çœ‹çœ‹ä¼šæ€æ ·ï¼Œå®ƒä¼šè§¦å‘ <code>InnerRepeatObserver</code> çš„ <code>onNext()</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-java">final class InnerRepeatObserver extends AtomicReference&lt;Disposable&gt; implements Observer&lt;Object&gt; {

    private static final long serialVersionUID = 3254781284376480842L;

    @Override
    public void onSubscribe(Disposable d) {
        DisposableHelper.setOnce(this, d);
    }

    @Override
    public void onNext(Object t) {
        innerNext();
    }

    @Override
    public void onError(Throwable e) {
        innerError(e);
    }

    @Override
    public void onComplete() {
        innerComplete();
    }
}
</code></pre>
<p><code>InnerRepeatObserver</code> æ˜¯ <code>RepeatWhenObserver</code> çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œæ‰€ä»¥å®ƒçš„ <code>onNext()</code> ä¸­è°ƒç”¨çš„ <code>innerNext()</code> æ–¹æ³•ä¸º <code>RepeatWhenObserver</code> çš„ï¼š</p>
<pre><code class="language-java">void innerNext() {
    subscribeNext();
}
</code></pre>
<p>è¿™æ ·å°±æ¸…æ¥šäº†ï¼Œé‡Œé¢åˆè°ƒç”¨ <code>RepeatWhenObserver</code> çš„ <code>subscribeNext()</code> æ–¹æ³•ï¼Œä¸Šé¢å·²ç»åˆ†æè¿‡äº†ï¼Œè¯¥æ–¹æ³•ä¼šè®© <code>RepeatWhenObserver</code> è‡ªå·±è®¢é˜…æˆ‘ä»¬çš„åŸå§‹ä¸Šæ¸¸ <code>source</code> ( <code>upstream</code> ) ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬åªè¦è®© <code>other</code> å³æˆ‘ä»¬è¿”å›çš„æµå‘å°„ä¸€æ¬¡ <code>onNext()</code> äº‹ä»¶å³å¯å®Œæˆé‡æ–°è®¢é˜…è¾¾åˆ°é‡è¯•ï¼Œé‚£æ€ä¹ˆè§¦å‘ <code>other</code> å‘å°„äº‹ä»¶å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ä¸Šé¢çš„ <code>signaller</code> ã€‚ä¸Šæ¸¸å‡ºé”™æ—¶ï¼Œä¼šå¯¼è‡´ <code>signaller</code> å°†é”™è¯¯ä¿¡æ¯å½“æˆæ­£å¸¸æ—¶é—´å‘å°„å‡ºå»ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦è®© <code>signaller</code> è§¦å‘ <code>other</code> å³å¯ï¼Œå¯ä»¥ç†è§£ä¸ºåªè¦å°† <code>other</code> å’Œ <code>signaller</code> ç›¸è¿æ¥å³å¯ï¼š</p>
<pre><code class="language-java">upStream.retryWhen(new Function&lt;Observable&lt;Throwable&gt;, ObservableSource&lt;?&gt;&gt;() {
    @Override
    public ObservableSource&lt;?&gt; apply(Observable&lt;Throwable&gt; attempts) throws Exception {
        System.out.println(&quot;retryWhen: apply()&quot;);
        return attempts.flatMap(throwable -&gt; {
            System.out.println(&quot;attempts: flatMap apply() -&gt; &quot; + throwable);
            Thread.sleep(1000);
            return Observable.just(&quot;just retry&quot;);
        });
    }
}).subscribe(downStream);
</code></pre>
<p>åœ¨ <code>attempts.flatMap</code> ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ‹¿åˆ° <code>attempts</code> ä¸­çš„é”™è¯¯ä¿¡æ¯æ¥åˆ¤æ–­æ˜¯å¦é‡è¯•ï¼Œå¦‚æœé‡è¯•åªè¦å‘å°„ä¸€ä¸ªæ­£å¸¸äº‹ä»¶å³å¯ï¼Œå‘ä¸Šé¢çš„ä¾‹å­ä¸€æ ·ï¼Œé‚£ä¸æƒ³é‡è¯•äº†å‘¢ï¼Ÿåªè¦å‘å°„ä¸€ä¸ª <code>onError()</code> é”™è¯¯äº‹ä»¶å³å¯ã€‚ç”±ä¸Šé¢ <code>InnerRepeatObserver</code> æºç å¯ä»¥çœ‹åˆ°å¦‚æœå‘å°„äº†ä¸€ä¸ªé”™è¯¯äº‹ä»¶ï¼Œä¼šè°ƒç”¨ <code>RepeatWhenObserver</code> çš„ <code>innerError()</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-java">void innerError(Throwable ex) {
    DisposableHelper.dispose(upstream);
    HalfSerializer.onError(downstream, ex, this, error);
}
</code></pre>
<pre><code class="language-java">public static void onError(Observer&lt;?&gt; observer, Throwable ex,
        AtomicInteger wip, AtomicThrowable error) {
    if (error.addThrowable(ex)) {
        if (wip.getAndIncrement() == 0) {
            observer.onError(error.terminate());
        }
    } else {
        RxJavaPlugins.onError(ex);
    }
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°å†…éƒ¨ä¼šè°ƒç”¨ <code>downstream</code> çš„ <code>onError()</code> æ–¹æ³•ï¼Œå®Œæˆè½¬å‘æ“ä½œã€‚</p>
<p>è‡³æ­¤å·²ç»åˆ†æå®Œäº†ï¼Œä¸‹é¢é™„ä¸Šæµç¨‹å›¾æ–¹ä¾¿ç†è§£ï¼š</p>
<blockquote>
<p>RWO : <code>RepeatWhenObserver</code></p>
<p>IRO : <code>InnerRepeatObserver</code></p>
</blockquote>
<figure data-type="image" tabindex="1"><img src="http://ww3.sinaimg.cn/large/006tNc79ly1g543bldi53j31a80u0jvr.jpg" alt=""></figure>

          </div>
        </div>

        
          <div class="next-post">
            <a class="purple-link" href="https://www.imhanjie.com//post/java-dynamic-proxy">
              <h3 class="post-title">
                ä¸‹ä¸€ç¯‡ï¼šJava åŠ¨æ€ä»£ç†åŠæºç ç®€æ
              </h3>
            </a>
          </div>
          
      </div>

      

      <div class="site-footer">
  <div class="slogan">Keep Alive.</div>
  <div class="social-container">
    
      
        <a href="https://github.com/imhanjie" target="_blank">
          <i class="fab fa-github"></i>
        </a>
      
    
      
    
      
        <a href="https://weibo.com/95han" target="_blank">
          <i class="fab fa-weibo"></i>
        </a>
      
    
      
    
      
    
  </div>
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://www.imhanjie.com//atom.xml" target="_blank">RSS</a>
</div>


    </div>
    <script type="application/javascript">

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
