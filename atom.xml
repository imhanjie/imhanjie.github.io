<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://www.imhanjie.com</id>
    <title>Melody</title>
    <updated>2020-01-06T05:42:16.796Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://www.imhanjie.com"/>
    <link rel="self" href="https://www.imhanjie.com/atom.xml"/>
    <subtitle>Keep Alive.</subtitle>
    <logo>https://www.imhanjie.com/images/avatar.png</logo>
    <icon>https://www.imhanjie.com/favicon.ico</icon>
    <rights>All rights reserved 2020, Melody</rights>
    <entry>
        <title type="html"><![CDATA[Docker | åˆ¶ä½œå±äºè‡ªå·±çš„ Jenkins é•œåƒ]]></title>
        <id>https://www.imhanjie.com/post/custom-docker-image</id>
        <link href="https://www.imhanjie.com/post/custom-docker-image">
        </link>
        <updated>2019-12-29T16:09:58.000Z</updated>
        <summary type="html"><![CDATA[<p>æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½éœ€è¦ä¸ºäº†æ»¡è¶³è‡ªå·±çš„éœ€æ±‚æ¥åˆ¶ä½œè‡ªå·±çš„  Docker é•œåƒã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½éœ€è¦ä¸ºäº†æ»¡è¶³è‡ªå·±çš„éœ€æ±‚æ¥åˆ¶ä½œè‡ªå·±çš„  Docker é•œåƒã€‚</p>
<!-- more -->
<h2 id="å‰è¨€">å‰è¨€</h2>
<p>æœ€è¿‘æˆ‘åœ¨ä½¿ç”¨ Docker æ­å»º Jenkins è‡ªåŠ¨åŒ–æ„å»ºå¹³å°æ—¶é‡åˆ°äº†å„ç§ç¯å¢ƒé—®é¢˜ï¼Œä¾‹å¦‚åœ¨ Jenkins å®˜æ–¹çš„é•œåƒå†…æ˜¯æ²¡æœ‰ mavenã€Android SDKã€npm ç­‰ç¯å¢ƒçš„ï¼Œè‡ªç„¶ä¹Ÿå°±æ²¡æ³•ä½¿ç”¨ Jenkins æ¥æ„å»ºç¼–è¯‘æˆ‘ä»¬çš„é¡¹ç›®ï¼Œè¿™é‡Œæœ‰ä¸‰ç§è§£å†³åŠæ³•ï¼š</p>
<h5 id="1-ç›´æ¥è¿›å…¥åˆ°-jenkins-å®¹å™¨å†…éƒ¨å®‰è£…ç›¸å…³ç¯å¢ƒ">1. ç›´æ¥è¿›å…¥åˆ° Jenkins å®¹å™¨å†…éƒ¨å®‰è£…ç›¸å…³ç¯å¢ƒã€‚</h5>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®‰è£…ç›¸å…³ç›¸å…³ç¯å¢ƒåè¦ç¡®ä¿å®¹å™¨ä¸èƒ½è¢«åˆ é™¤ï¼Œå®¹æ˜“ä¸€æ—¦è¢«åˆ é™¤ï¼Œé‚£ä¹ˆé‡Œé¢æ‰€åšçš„å˜æ›´éƒ½æ¶ˆå¤±äº†ï¼Œæ‰€ä»¥ä¸æ¨èã€‚</p>
<h5 id="2-åœ¨å®¿ä¸»æœºä¸Šå®‰è£…ç›¸å…³ç¯å¢ƒç„¶åé€šè¿‡-docker-æŒ‚è½½å·çš„å½¢å¼æ˜ å°„åˆ°å®¹å™¨å†…éƒ¨">2. åœ¨å®¿ä¸»æœºä¸Šå®‰è£…ç›¸å…³ç¯å¢ƒï¼Œç„¶åé€šè¿‡ Docker æŒ‚è½½å·çš„å½¢å¼æ˜ å°„åˆ°å®¹å™¨å†…éƒ¨ã€‚</h5>
<p>è¿™ç§æ–¹å¼å¦‚æœå®¿ä¸»æœºæœ‰ç›¸å…³ç¯å¢ƒæ˜¯éå¸¸æ–¹ä¾¿çš„ï¼Œå¯ä»¥ç›´æ¥ç¯å¢ƒçš„ä½ç½®ä»¥æŒ‚è½½å·çš„å½¢å¼æ˜ å°„åˆ°å®¹å™¨å†…éƒ¨è®©å®¹å™¨èƒ½è®¿é—®åˆ°å®¿ä¸»æœºçš„ç¯å¢ƒï¼Œä½†ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå¦‚æœéœ€è¦å°† Jenkins è¿ç§»åˆ°å…¶ä»–æœåŠ¡å™¨ä¸Šï¼Œé‚£ä¹ˆè¿™äº›ç¯å¢ƒæ˜¯æ²¡æ³•è¿ç§»çš„ï¼Œéœ€è¦åˆ°è¿ç§»çš„æœåŠ¡å™¨ä¸Šå†å®‰è£…ä¸€éçš„ï¼Œæ‰€ä»¥ç»¼ä¸Šä¸¤ç§æ–¹å¼æœ‰äº†ä¸‹é¢çš„ç¬¬ä¸‰ç§æ–¹å¼ã€‚</p>
<h5 id="3-å°†ç›¸å…³ç¯å¢ƒç›´æ¥æ‰“åŒ…è¿›-jenkins-é•œåƒä¸­">3. å°†ç›¸å…³ç¯å¢ƒç›´æ¥æ‰“åŒ…è¿› Jenkins é•œåƒä¸­ã€‚</h5>
<p>è¿™ç§æ–¹å¼éœ€è¦æˆ‘ä»¬åœ¨å®˜æ–¹ Jenkins é•œåƒçš„åŸºç¡€ä¸Šå®šåˆ¶å±äºæˆ‘ä»¬è‡ªå·±çš„ Jenkins é•œåƒï¼Œå’Œç¬¬ä¸€ç§æ–¹å¼ä¸€æ ·ï¼Œç¯å¢ƒæ˜¯å®‰è£…åœ¨å®¹å™¨å†…éƒ¨çš„ï¼Œä½†æ˜¯ä¸åŒçš„æ˜¯å®¹å™¨è‹¥è¢«åˆ é™¤ï¼Œä¸‹æ¬¡é‡æ–°åˆ›å»ºå®¹å™¨çš„æ—¶å€™ç¯å¢ƒéƒ½æ˜¯è¿˜åœ¨çš„ï¼Œå› ä¸ºç¯å¢ƒå®‰è£…åœ¨ Image é•œåƒå†…éƒ¨çš„ã€‚æ‰€ä»¥è¿ç§»ä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œåªéœ€è¦æŠŠåˆ¶ä½œå¥½çš„é•œåƒä¸Šä¼ åˆ° DockerHub ä¸Šï¼Œç„¶åå…¶ä»–æœåŠ¡å™¨éœ€è¦ä½¿ç”¨çš„è¯åªéœ€è¦å°†é•œåƒæ‹‰å–ä¸‹æ¥å³å¯ã€‚</p>
<h2 id="é•œåƒåˆ¶ä½œ">é•œåƒåˆ¶ä½œ</h2>
<p>ä¸‹é¢å°±æ¥ä¸€æ­¥ä¸€æ­¥åˆ¶ä½œæˆ‘ä»¬çš„ Jenkins é•œåƒï¼Œåˆ†åˆ«æ¼”ç¤ºå°† Mavenã€Android SDKã€Node.js ç¯å¢ƒæ‰“åŒ…åˆ°é•œåƒä¸­ã€‚</p>
<h4 id="ç¼–å†™-dockerfile-æ–‡ä»¶">ç¼–å†™ Dockerfile æ–‡ä»¶</h4>
<p>é¦–å…ˆåˆ›å»ºæˆ‘ä»¬çš„ Dockerfile æ–‡ä»¶ï¼Œç„¶åç¼–å†™ã€‚</p>
<ol>
<li>
<h5 id="é€‰å®šåŸºç¡€é•œåƒ">é€‰å®šåŸºç¡€é•œåƒ</h5>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Jenkins å®˜æ–¹æä¾›çš„ Jenkins é•œåƒä½œä¸ºåŸºç¡€é•œåƒã€‚</p>
<pre><code class="language-dockerfile">FROM jenkins/jenkins:lts
</code></pre>
</li>
<li>
<h5 id="å®‰è£…å¿…è¦çš„è¾…åŠ©å·¥å…·">å®‰è£…å¿…è¦çš„è¾…åŠ©å·¥å…·</h5>
<p>å› ä¸ºåé¢æ¶‰åŠåˆ° zip å‹ç¼©åŒ…ä¸‹è½½ã€è§£å‹æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆå®‰è£… <code>curl</code>ã€<code>unzip</code> å‘½ä»¤ã€‚</p>
<pre><code class="language-dockerfile">RUN apt-get update \
    &amp;&amp; echo Y | apt-get install curl \
    &amp;&amp; apt-get install unzip
</code></pre>
</li>
<li>
<h5 id="å®‰è£…-maven-ç¯å¢ƒ">å®‰è£… Maven ç¯å¢ƒ</h5>
<pre><code class="language-dockerfile">ARG MAVEN_URL=&quot;http://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.zip&quot;
ARG USER_LOCAL=&quot;/usr/local&quot;
ENV MAVEN_HOME=&quot;$USER_LOCAL/maven&quot;

RUN cd $MAVEN_HOME \
    &amp;&amp; curl -o maven.zip $MAVEN_URL \
    &amp;&amp; unzip maven.zip \
    &amp;&amp; rm maven.zip
</code></pre>
<ul>
<li><code>ARG</code>ï¼šç”¨äºå®šä¹‰å¸¸é‡ï¼Œä»…åœ¨å½“å‰ Dockerfile æœ‰æ•ˆã€‚</li>
<li><code>ENV</code>ï¼šä¹Ÿæ˜¯å®šäºå¸¸é‡ï¼Œå½“æ—¶åœ¨æ„å»ºé•œåƒæ—¶ï¼Œä¼šä½œä¸ºç¯å¢ƒå˜é‡æ‰“åˆ°é•œåƒå†…éƒ¨ã€‚</li>
<li><code>curl -o</code> ï¼šä¸‹è½½æ–‡ä»¶ã€‚</li>
</ul>
</li>
<li>
<h5 id="å®‰è£…-android-sdk-ç¯å¢ƒ">å®‰è£… Android SDK ç¯å¢ƒ</h5>
<pre><code class="language-dockerfile">ARG USER_LOCAL=&quot;/usr/local&quot;
ARG SDK_MANAGER_URL=&quot;https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip&quot;
ENV ANDROID_HOME=&quot;$USER_LOCAL/Android/sdk&quot;

RUN cd $ANDROID_HOME \
    &amp;&amp; curl -o sdk.zip $SDK_MANAGER_URL \
    &amp;&amp; unzip sdk.zip \
    &amp;&amp; rm sdk.zip \
    &amp;&amp; cd tools \
    &amp;&amp; echo Y | $ANDROID_HOME/tools/bin/sdkmanager &quot;extras;android;m2repository&quot; &quot;platform-tools&quot; &quot;platforms;android-28&quot; &quot;build-tools;28.0.3&quot; &quot;cmake;3.10.2.4988404&quot;
</code></pre>
<ul>
<li><code>echo Y</code>ï¼šå› ä¸ºæœ‰äº›æ“ä½œéœ€è¦ç”¨æˆ·è¾“å…¥ Y/n ç¡®è®¤ï¼Œæ‰€ä»¥è¿™å¥çš„æ„æ€æ˜¯ä»£æ›¿ç”¨æˆ·è¾“å…¥ Yã€‚</li>
</ul>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Andoird æä¾›çš„å‘½ä»¤è¡Œå·¥å…· sdkmanager å»å®‰è£… sdkï¼Œè¿™é‡Œæˆ‘ä»¬å®‰è£…äº† android-28ã€build-tools 28.0.3 ç‰ˆæœ¬ï¼Œä»¥åŠ cmakeã€‚</p>
<p>å¯ä»¥ä½¿ç”¨ <code>sdkmanager list</code> å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å¯å®‰è£…çš„ç¯å¢ƒã€‚</p>
<p>è¯¦ç»†çš„ sdkmanager ä½¿ç”¨å¯ä»¥æŸ¥çœ‹<a href="https://developer.android.com/studio/command-line/sdkmanager">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
</li>
<li>
<h5 id="å®‰è£…-nodejs-ç¯å¢ƒ">å®‰è£… Node.js ç¯å¢ƒ</h5>
<p>å®‰è£… Node.js çš„å‘½ä»¤æ˜¯é€šè¿‡ apt æ¥å®‰è£…çš„ï¼Œè¯¦è§<a href="https://github.com/nodesource/distributions/blob/master/README.md">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<pre><code class="language-dockerfile">RUN curl -sL https://deb.nodesource.com/setup_11.x | bash - \
    &amp;&amp; apt-get install -y nodejs
</code></pre>
</li>
<li>
<h5 id="å°†å„ç¯å¢ƒæ·»åŠ åˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­">å°†å„ç¯å¢ƒæ·»åŠ åˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­</h5>
<pre><code class="language-dockerfile">ENV PATH $MAVEN_HOME/apache-maven-3.6.3/bin:$ANDROID_HOME/tools:$ANDROID_HOME/tools/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmake/3.10.2.4988404/bin:$PATH
</code></pre>
</li>
<li>
<h5 id="æœ€ååšä¸€äº›æ¸…ç†æ“ä½œ">æœ€ååšä¸€äº›æ¸…ç†æ“ä½œ</h5>
<p>å°½é‡åœ¨é•œåƒä¸­ä¸è¦æ”¾ä¸€äº›å†—ä½™çš„æ— ç”¨æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦åšä¸€äº›æ¸…ç†æ“ä½œã€‚</p>
<pre><code class="language-dockerfile">RUN apt-get clean   
</code></pre>
</li>
<li>
<h5 id="å®Œæ•´çš„-dockerfile-æ–‡ä»¶">å®Œæ•´çš„ Dockerfile æ–‡ä»¶</h5>
<pre><code class="language-dockerfile">FROM jenkins/jenkins:lts
USER root

ARG USER_LOCAL=&quot;/usr/local&quot;
ARG SDK_MANAGER_URL=&quot;https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip&quot;
ARG MAVEN_URL=&quot;http://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.zip&quot;
ENV ANDROID_HOME=&quot;$USER_LOCAL/Android/sdk&quot;
ENV MAVEN_HOME=&quot;$USER_LOCAL/maven&quot;

RUN mkdir -p $ANDROID_HOME \
    &amp;&amp; mkdir -p $MAVEN_HOME \
    &amp;&amp; apt-get update \
    &amp;&amp; echo Y | apt-get install curl \
    &amp;&amp; apt-get install unzip \
    &amp;&amp; cd $MAVEN_HOME \
    &amp;&amp; curl -o maven.zip $MAVEN_URL \
    &amp;&amp; unzip maven.zip \
    &amp;&amp; rm maven.zip \
    &amp;&amp; cd $ANDROID_HOME \
    &amp;&amp; curl -o sdk.zip $SDK_MANAGER_URL \
    &amp;&amp; unzip sdk.zip \
    &amp;&amp; rm sdk.zip \
    &amp;&amp; cd tools \
    &amp;&amp; echo Y | $ANDROID_HOME/tools/bin/sdkmanager &quot;extras;android;m2repository&quot; &quot;platform-tools&quot; &quot;platforms;android-28&quot; &quot;build-tools;28.0.3&quot; &quot;cmake;3.10.2.4988404&quot; \
    &amp;&amp; curl -sL https://deb.nodesource.com/setup_11.x | bash - \
    &amp;&amp; apt-get install -y nodejs

ENV PATH $MAVEN_HOME/apache-maven-3.6.3/bin:$ANDROID_HOME/tools:$ANDROID_HOME/tools/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmake/3.10.2.4988404/bin:$PATH

RUN apt-get clean
</code></pre>
<blockquote>
<p>Docker é•œåƒåˆ†å±‚å­˜å‚¨ç»“æ„ï¼Œå±‚æ•°æ˜¯æœ‰é™åˆ¶çš„ï¼ŒDockerfile ä¸­æ¯ä¸ªå‘½ä»¤å°†ä½œä¸ºä¸€å±‚ï¼Œæ‰€ä»¥å°½é‡å°†å¯æ”¾åœ¨ä¸€èµ·ä¸€äº›æ“ä½œæ”¾åœ¨ä¸€ä¸ªå‘½ä»¤å†…ï¼Œä¾‹å¦‚ä¸Šé¢ä¸å¿…å†™å¾ˆå¤š <code>RUN</code>ï¼Œå°†å‘½ä»¤æ”¾åœ¨ä¸€èµ·ä¼šæ›´å¥½ï¼Œäº†è§£æ›´å¤šå†™æ³•å¯å‚è€ƒ<a href="https://yeasy.gitbooks.io/docker_practice/image/build.html">è¿™é‡Œ</a>ã€‚</p>
</blockquote>
</li>
</ol>
<h4 id="æ„å»ºé•œåƒ">æ„å»ºé•œåƒ</h4>
<pre><code class="language-dockerfile">docker build -t my_jenkins .
</code></pre>
<ul>
<li><code>-t</code>ï¼šæŒ‡å®šé•œåƒåã€‚</li>
</ul>
<blockquote>
<p>æœ€åçš„ . ä¸è¦å¿˜è®°ï¼Œç”¨äºæŒ‡å®š<a href="https://yeasy.gitbooks.io/docker_practice/image/build.html">æ„å»ºä¸Šä¸‹æ–‡ç¯å¢ƒ</a>ï¼Œå¦‚æœ Dockerfile æ–‡ä»¶æ²¡æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆæ„å»ºåº”è¯¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå…¶ä¸­å®‰è£… Android SDK å¯èƒ½éœ€è¦è€—æ—¶ä¸€ç‚¹ã€‚</p>
</blockquote>
<h2 id="ä¸Šä¼ é•œåƒåˆ°-dockerhub">ä¸Šä¼ é•œåƒåˆ° DockerHub</h2>
<ol>
<li>
<h5 id="æ³¨å†Œ-dockerhub-è´¦å·">æ³¨å†Œ DockerHub è´¦å·</h5>
<p>æƒ³è¦ä¸Šä¼ é•œåƒåˆ° <a href="https://hub.docker.com/">DockerHub</a> éœ€è¦æå‰æ³¨å†Œä¸€ä¸ªè´¦å·ã€‚</p>
</li>
<li>
<h5 id="åœ¨æœ¬åœ°ç™»å½•-dockerhub-è´¦å·">åœ¨æœ¬åœ°ç™»å½• DockerHub è´¦å·</h5>
<pre><code class="language-visual">docker login
</code></pre>
<p>å¯ä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤æŒ‰ç…§æç¤ºç™»å…¥ä½ çš„è´¦å·</p>
</li>
<li>
<h5 id="æ¨é€åˆšåˆšæ„å»ºçš„é•œåƒ">æ¨é€åˆšåˆšæ„å»ºçš„é•œåƒ</h5>
<pre><code class="language-dockerfile">docker tag my_jenkins imhanjie/my_jenkins
docker push my_jenkins
</code></pre>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ <code>push</code> ä¹‹å‰ï¼Œè‚¯å®šæ˜¯è¦æ¨é€åˆ°è‡ªå·±çš„ä»“åº“ï¼Œæ‰€ä»¥æ ¹æ®é•œåƒåç§°çš„è§„åˆ™ï¼Œéœ€è¦åœ¨é•œåƒå‰é¢åŠ ä¸Šä½ è‡ªå·±çš„ DockerHub çš„ç”¨æˆ·åï¼Œè¿™æ ·æ‰ä¼šæ¨é€åˆ°ä½ çš„ä»“åº“ä¸‹ï¼ŒæŒ‡å®šç”¨æˆ·åçš„å½¢å¼å°±æ˜¯ <code>your_username/image_name</code> ï¼Œæˆ‘çš„ DockerHub åå­—æ˜¯ <code>imhanjie</code> ï¼Œæ‰€ä»¥é¦–å…ˆæ ¹æ®æœ¬åœ°çš„ <code>my_jenkis</code> é•œåƒæ·»åŠ ä¸€ä¸ª tagï¼Œåç§°ä¸º <code>imhanjie/my_jenkins</code> ï¼Œç„¶å <code>push</code> å°±å¯ä»¥äº†ï¼Œæœ€åå°±å¯ä»¥åœ¨ DockerHub ä¸Šçœ‹è§è‡ªå·±åˆšåˆšæ¨é€çš„é•œåƒäº†ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1gae1hmd3lxj31ha0cq0ud.jpg" alt="" loading="lazy"></figure>
</li>
</ol>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://yeasy.gitbooks.io/docker_practice/">Docker â€” ä»å…¥é—¨åˆ°å®è·µ</a></li>
<li><a href="https://developer.android.com/studio/command-line/sdkmanager">sdkmanager</a></li>
<li><a href="https://github.com/nodesource/distributions/blob/master/README.md">NodeSource Node.js Binary Distributions</a></li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[RxJava 2 | retryWhen æ“ä½œç¬¦æºç åˆ†æ]]></title>
        <id>https://www.imhanjie.com/post/rxjava-retryWhen-analysis</id>
        <link href="https://www.imhanjie.com/post/rxjava-retryWhen-analysis">
        </link>
        <updated>2019-07-18T02:41:08.000Z</updated>
        <content type="html"><![CDATA[<!--more-->
<h3 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h3>
<p><code>retryWhen</code> æ“ä½œç¬¦çš„ä½œç”¨æ˜¯åœ¨ä¸Šæ¸¸å‘å°„äº†ä¸€ä¸ªé”™è¯¯äº‹ä»¶æ—¶ï¼Œå¯ä»¥æ ¹æ®æ¡ä»¶è‡ªå·±å†³å®šæ˜¯å¦è¿›è¡Œé‡è¯•ï¼Œè®©ä¸Šæ¸¸é‡æ–°å‘é€äº‹ä»¶ã€‚åœ¨å¼€å‘ä¸­ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ“ä½œç¬¦ï¼Œä¾‹å¦‚å®ƒå¯ä»¥ç”¨æ¥åœ¨ç½‘ç»œè¯·æ±‚å¤±è´¥æ—¶è¦æ±‚å…¶è¿›è¡Œé‡è¯•ï¼Œé‡æ–°å»è¿›è¡Œç½‘ç»œè¯·æ±‚ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä½¿ç”¨æ¡ˆä¾‹ï¼š</p>
<pre><code class="language-java">Observable
        .create((ObservableOnSubscribe&lt;String&gt;) e -&gt; {
            e.onNext(&quot;A&quot;);
            e.onNext(&quot;B&quot;);
            e.onError(new RuntimeException(&quot;always on error!&quot;));
            e.onNext(&quot;C&quot;);
            e.onComplete();
        })
        .retryWhen(attempts -&gt; {
            System.out.println(&quot;retryWhen: apply()&quot;);
            return attempts.flatMap(throwable -&gt; {
                System.out.println(&quot;attempts: flatMap apply() -&gt; &quot; + throwable);
                return Observable.just(&quot;just retry!&quot;);
            });
        })
        .subscribe(new Observer&lt;String&gt;() {
            @Override
            public void onSubscribe(Disposable d) {
                System.out.println(&quot;onSubscribe()&quot;);
            }

            @Override
            public void onNext(String s) {
                System.out.println(&quot;onNext(): &quot; + s);
            }

            @Override
            public void onError(Throwable e) {
                System.out.println(&quot;onError(): &quot; + e);
            }

            @Override
            public void onComplete() {
                System.out.println(&quot;onComplete()&quot;);
            }
        });
</code></pre>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code>retryWhen: apply()
onSubscribe()
onNext(): A
onNext(): B
attempts: flatMap apply() -&gt; java.lang.RuntimeException: always on error!
onNext(): A
onNext(): B
attempts: flatMap apply() -&gt; java.lang.RuntimeException: always on error!
onNext(): A
onNext(): B
attempts: flatMap apply() -&gt; java.lang.RuntimeException: always on error!
...
</code></pre>
<p>å¦‚æœå°†ä»¥ä¸Šä»£ç ä¸­çš„ï¼š</p>
<pre><code class="language-java">return Observable.just(&quot;just retry!&quot;);
</code></pre>
<p>æ›´æ”¹ä¸ºä¸‹é¢è¿™æ ·ï¼š</p>
<pre><code class="language-java">return Observable.error(new RuntimeException(&quot;shutdown!&quot;))
</code></pre>
<p>å†çœ‹è¾“å‡ºç»“æœï¼š</p>
<pre><code>retryWhen: apply()
onSubscribe()
onNext(): A
onNext(): B
attempts: flatMap apply()
onError(): java.lang.RuntimeException: shutdown!
</code></pre>
<p>ä¸ºäº†ä¸‹é¢ç†è§£æ–¹ä¾¿ï¼Œå°†ä¸Šé¢çš„ä»£ç æ”¹å†™æˆä¸‹é¢ ğŸ‘‡ è¿™æ ·ï¼Œä»£ç é€»è¾‘ä¸€æ¨¡ä¸€æ ·ï¼Œåªæ˜¯ä¸ä½¿ç”¨é“¾å¼è°ƒç”¨å¹¶ä¸”å»æ‰äº† <code>retryWhen</code> çš„ lambda è¡¨è¾¾å¼ï¼Œæ‹†åˆ†å‡ºä¸Šæ¸¸ <code>upStream</code> å’Œä¸‹æ¸¸ <code>downStream</code> çš„æ¦‚å¿µï¼š</p>
<pre><code class="language-java">// ä¸Šæ¸¸
Observable&lt;String&gt; upStream = Observable.create(e -&gt; {
    e.onNext(&quot;A&quot;);
    e.onNext(&quot;B&quot;);
    e.onError(new RuntimeException(&quot;always on error!&quot;));
    e.onNext(&quot;C&quot;);
    e.onComplete();
});

// ä¸‹æ¸¸
Observer&lt;String&gt; downStream = new Observer&lt;String&gt;() {
    @Override
    public void onSubscribe(Disposable d) {
        System.out.println(&quot;onSubscribe()&quot;);
    }

    @Override
    public void onNext(String s) {
        System.out.println(&quot;onNext(): &quot; + s);
    }

    @Override
    public void onError(Throwable e) {
        System.out.println(&quot;onError(): &quot; + e);
    }

    @Override
    public void onComplete() {
        System.out.println(&quot;onComplete()&quot;);
    }
};

// retryWhen
upStream.retryWhen(new Function&lt;Observable&lt;Throwable&gt;, ObservableSource&lt;?&gt;&gt;() {
    @Override
    public ObservableSource&lt;?&gt; apply(Observable&lt;Throwable&gt; attempts) throws Exception {
        System.out.println(&quot;retryWhen: apply()&quot;);
        return attempts.flatMap(throwable -&gt; {
            System.out.println(&quot;attempts: flatMap apply() -&gt; &quot; + throwable);
            Thread.sleep(1000);
            return Observable.just(&quot;just retry&quot;);
        });
    }
}).subscribe(downStream);
</code></pre>
<p>ä»¥ä¸Šå°±æ˜¯ <code>retryWhen</code> æ“ä½œç¬¦çš„åŸºæœ¬ä½¿ç”¨ï¼Œå¦‚æœåœ¨ <code>retryWhen</code> ä¸­ <code>return</code> è¿”å›çš„æµå‘å°„äº†ï¼š</p>
<ul>
<li>ä¸€ä¸ªæ­£å¸¸äº‹ä»¶ï¼Œå³ä»£è¡¨é‡è¯•ï¼Œä¼šé‡æ–°å‘å°„ä¸Šæ¸¸çš„äº‹ä»¶ã€‚</li>
<li>ä¸€ä¸ªé”™è¯¯äº‹ä»¶ï¼Œå³ä»£è¡¨ä¸æƒ³é‡è¯•ï¼Œä¼šç«‹å³è°ƒç”¨ä¸‹æ¸¸çš„ <code>onError()</code> æ–¹æ³•ï¼Œå¹¶ä¸”ä¼šå°†è¿™ä¸ªé”™è¯¯äº‹ä»¶ä¸­çš„å¼‚å¸¸ä¿¡æ¯ä½œä¸ºå‚æ•°ä¼ è¿‡å»ã€‚</li>
</ul>
<p>ä»ä¸Šé¢çš„è¾“å‡ºè¿˜å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼Œ<code>retryWhen</code> çš„ <code>Function</code> çš„ <code>apply()</code> æ–¹æ³•<strong>åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡</strong>ï¼Œå¹¶ä¸”æ˜¯åœ¨ä¸‹æ¸¸ <code>onSubscribe()</code>  æ–¹æ³•ä¹‹å‰è°ƒç”¨ï¼Œ<strong>å¹¶ä¸æ˜¯åœ¨æ¯æ¬¡ä¸Šæ¸¸å‡ºé”™éƒ½ä¼šå»è°ƒç”¨</strong>ã€‚</p>
<p>åœ¨ <code>retryWhen</code> çš„ <code>Function</code> çš„ <code>apply()</code> æ–¹æ³•ä¸­æœ‰ä¸€ä¸ª <code>Observable&lt;Throwable&gt; attempts</code> å‚æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæµï¼Œæ˜¯ <code>retryWhen</code> æ“ä½œç¬¦å†…éƒ¨ ( å‡†ç¡®çš„æ˜¯ <code>ObservableRetryWhen</code> å†… ) çš„ä¸€ä¸ªæµï¼Œå½“ä¸Šæ¸¸å‡ºé”™æ—¶ï¼Œè™½ç„¶ <code>retryWhen</code> çš„ <code>Function</code> çš„ <code>apply()</code> æ–¹æ³•ä¸ä¼šè¢«è°ƒç”¨ï¼Œä½†æ˜¯ä¼šå°†æ¯æ¬¡é”™è¯¯ä¿¡æ¯ä» <code>attempts</code> ä¸­å‘å°„å‡ºå»ï¼Œæ‰€ä»¥ä¸Šæ¸¸æ¯å‡ºç°é”™è¯¯æ—¶ï¼Œ<code>attempts</code> å°±ä¼šå‘å°„ä¸€æ¬¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ ¹æ® <code>attempts</code> çš„é”™è¯¯ä¿¡æ¯æ¥å†³å®šæ˜¯å¦é‡è¯•ã€‚</p>
<p>ä»¥ä¸Šç»“è®ºä¼šåœ¨ä¸‹é¢æºç åˆ†æä¸­å¾—åˆ°è®ºè¯ã€‚</p>
<h3 id="æµç¨‹åˆ†æ">æµç¨‹åˆ†æ</h3>
<p>é¦–å…ˆçœ‹ <code>create()</code> ï¼š</p>
<pre><code class="language-java">public static &lt;T&gt; Observable&lt;T&gt; create(ObservableOnSubscribe&lt;T&gt; source) {
    ObjectHelper.requireNonNull(source, &quot;source is null&quot;);
    return RxJavaPlugins.onAssembly(new ObservableCreate&lt;T&gt;(source));
}
</code></pre>
<p>ä¾‹å­ä¸­åˆ›å»ºä¸Šæ¸¸æ—¶ä½¿ç”¨çš„æ˜¯ <code>create()</code> æ“ä½œç¬¦ï¼Œæ­¤æ—¶æµ <code>Observable</code> çš„å®é™…ç±»å‹ä¸º <code>ObservableCreate</code> ï¼Œç„¶åç»è¿‡  <code>retryWhen</code> ï¼š</p>
<pre><code class="language-java">public final Observable&lt;T&gt; retryWhen(
    final Function&lt;? super Observable&lt;Throwable&gt;, ? extends ObservableSource&lt;?&gt;&gt; handler) {
    ObjectHelper.requireNonNull(handler, &quot;handler is null&quot;);
    return RxJavaPlugins.onAssembly(new ObservableRetryWhen&lt;T&gt;(this, handler));
}
</code></pre>
<p>ç»è¿‡ <code>retryWhen</code> æ“ä½œç¬¦åï¼Œæµçš„ç±»å‹å˜ä¸º <code>ObservableRetryWhen</code> ï¼Œç„¶åä¸‹æ¸¸è®¢é˜…ä¸Šæ¸¸è°ƒç”¨ <code>subscribe()</code> æ—¶ï¼Œè°ƒç”¨çš„æ˜¯ <code>ObservableRetryWhen</code> çš„ <code>subscribe()</code> æ–¹æ³•ï¼Œå†…éƒ¨ä¼šæœ€ç»ˆè°ƒç”¨å…¶ <code>subscribeActual()</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-java">@Override
protected void subscribeActual(Observer&lt;? super T&gt; observer) {
  	// ä¿¡å·æºï¼Œå³ä¸Šæ–‡ä¸­æåˆ°çš„ attempts
    Subject&lt;Throwable&gt; signaller = PublishSubject.&lt;Throwable&gt;create().toSerialized();
		
    ObservableSource&lt;?&gt; other;

    try {
      	// æ‰€ä»¥ other å°±æ˜¯æˆ‘ä»¬åœ¨ retryWhen é‡Œé¢è¿”å›çš„é‚£ä¸ªæµï¼Œå³ Observable.just(&quot;just retry!&quot;)
        other = ObjectHelper.requireNonNull(handler.apply(signaller), &quot;The handler returned a null ObservableSource&quot;);
    } catch (Throwable ex) {
        Exceptions.throwIfFatal(ex);
        EmptyDisposable.error(ex, observer);
        return;
    }

    RepeatWhenObserver&lt;T&gt; parent = new RepeatWhenObserver&lt;T&gt;(observer, signaller, source);
    observer.onSubscribe(parent);

    other.subscribe(parent.inner);

    parent.subscribeNext();
}
</code></pre>
<h4 id="signaller">signaller</h4>
<p>åœ¨ <code>ObservableRetryWhen</code> è¢«è®¢é˜…æ—¶é¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ªä¿¡å·æº <code>signaller</code>ï¼Œå³ä¸Šæ–‡ä¸­æåˆ°çš„ <code>attempts</code> ï¼Œç”¨æ¥å‘å°„ä¸Šæ¸¸å‡ºç°çš„é”™è¯¯ã€‚</p>
<h4 id="other">other</h4>
<pre><code class="language-java">other = ObjectHelper.requireNonNull(handler.apply(signaller)
</code></pre>
<p><code>handler</code> å°±æ˜¯ <code>retryWhen</code> çš„å‚æ•° <code>Function</code> ï¼Œå¯ä»¥çœ‹åˆ°åœ¨è°ƒç”¨ <code>Function</code> çš„ <code>apply()</code> å‡½æ•°æ—¶å°† <code>signaller</code> ä½œä¸ºå‚æ•° ä¼ è¿‡å»äº†ï¼Œå°±æ˜¯åˆšåˆšå¤–é¢æåˆ°çš„ <code>attempts</code> å‚æ•°ï¼Œæ‰€ä»¥ <code>other</code> å°±æ˜¯ <code>Function</code> çš„è¿”å›å€¼ï¼Œå³ä½¿ç”¨ <code>retryWhen</code> æ“ä½œç¬¦è¿”å›çš„é‚£ä¸ªæµï¼š</p>
<pre><code class="language-java">Observable.just(&quot;just retry!&quot;)
</code></pre>
<h4 id="repeatwhenobserver">RepeatWhenObserver</h4>
<p><code>RepeatWhenObserver</code> åœ¨ <code>ObservableRetryWhen</code> å†…éƒ¨å°†åŸå§‹çš„ä¸Šæ¸¸ <code>source</code> ( <code>upstream</code> ) ä»¥åŠåŸå§‹çš„ä¸‹æ¸¸ <code>observer</code> ( <code>downstream</code> ) å°è£…èµ·æ¥ï¼Œé€šè¿‡å…¶å˜é‡å <code>parent</code> ä¹Ÿå¯ä»¥çœ‹å‡ºå…¶ä»£è¡¨çš„æ„æ€ä¸º <code>retryWhen</code> æ“ä½œç¬¦çš„ä¸Šæ¸¸ã€‚</p>
<h4 id="è®¢é˜…å…³ç³»">è®¢é˜…å…³ç³»</h4>
<pre><code class="language-java">other.subscribe(parent.inner);
</code></pre>
<p><code>parent.inner</code> å³ <code>RepeatWhenObserver</code> çš„å†…éƒ¨ç±» <code>InnerRepeatObserver</code> è®¢é˜…äº†æˆ‘ä»¬è¿”å›çš„æµã€‚ä¸‹é¢ä¼šæåˆ°ï¼Œè¿™é‡Œåªéœ€è¦çŸ¥é“ <code>parent.inner</code> è®¢é˜…äº†æˆ‘ä»¬è¿”å›çš„ <code>Observable.just(&quot;just retry!&quot;)</code> å³å¯ã€‚</p>
<pre><code class="language-java">parent.subscribeNext();
</code></pre>
<p>å†çœ‹ <code>RepeatWhenObserver</code> çš„ <code>subscribeNext()</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-java">void subscribeNext() {
    if (wip.getAndIncrement() == 0) {

        do {
            if (isDisposed()) {
                return;
            }

            if (!active) {
                active = true;
                source.subscribe(this);
            }
        } while (wip.decrementAndGet() != 0);
    }
}
</code></pre>
<p>å†…éƒ¨ä¼šè®© <code>RepeatWhenObserver</code> è‡ªå·±è®¢é˜…æˆ‘ä»¬çš„åŸå§‹ä¸Šæ¸¸ <code>source</code> ( <code>upstream</code> ) ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">è¢«è§‚å¯Ÿè€…</th>
<th>è§‚å¯Ÿè€…</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>upstream ( åŸå§‹æµ )</strong></td>
<td><strong>RepeatWhenObserver</strong></td>
</tr>
<tr>
<td style="text-align:left"><strong>other ( retryWhen ä¸­æˆ‘ä»¬è¿”å›çš„æµ )</strong></td>
<td><strong>InnerRepeatObserver</strong></td>
</tr>
</tbody>
</table>
<h4 id="é‡è¯•æœºåˆ¶">é‡è¯•æœºåˆ¶</h4>
<p>åœ¨å°†é‡è¯•æœºåˆ¶ä¹‹å‰ï¼Œä¼šå…ˆåˆ†ææ­£å¸¸çš„æµç¨‹ï¼Œå³ä¸Šæ¸¸ä¸ä¼šæŠ›å‡ºé”™è¯¯ä¸é‡è¯•çš„æµç¨‹ï¼Œç„¶åå†åˆ†æé”™è¯¯é‡è¯•çš„æµç¨‹ï¼Œå³ä¸Šæ¸¸å‘å°„é”™è¯¯äº‹ä»¶è§¦å‘é‡è¯•çš„æµç¨‹ã€‚</p>
<h5 id="æ­£å¸¸ä¸é‡è¯•æµç¨‹">æ­£å¸¸ä¸é‡è¯•æµç¨‹</h5>
<p>è¿˜æ˜¯æŒ‰ç…§ä¸Šé¢çš„ä¾‹å­ï¼Œä¸Šæ¸¸ <code>upstream</code> é¦–å…ˆå‘å°„ <code>A</code> ï¼Œç”±è®¢é˜…å…³ç³»å¾—çŸ¥ä¼šè§¦å‘ <code>RepeatWhenObserver</code> çš„ <code>onNext()</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-java">@Override
public void onNext(T t) {
    HalfSerializer.onNext(downstream, t, this, error);
}
</code></pre>
<pre><code class="language-java">public static &lt;T&gt; void onNext(Observer&lt;? super T&gt; observer, T value,
        AtomicInteger wip, AtomicThrowable error) {
    if (wip.get() == 0 &amp;&amp; wip.compareAndSet(0, 1)) {
        observer.onNext(value);
        ...
    }
}
</code></pre>
<p>æ­¤å¤„çš„ <code>observer</code> å°±æ˜¯çœŸæ­£çš„ä¸‹æ¸¸ <code>downstream</code>ã€‚å¯ä»¥çœ‹åˆ°å†…éƒ¨ä¼šè°ƒç”¨ <code>downstream</code> çš„ <code>onNext()</code> æ–¹æ³•ï¼Œå®Œæˆè½¬å‘æ“ä½œã€‚</p>
<h5 id="é”™è¯¯é‡è¯•æµç¨‹">é”™è¯¯é‡è¯•æµç¨‹</h5>
<p>æŒ‰ç…§ä¸Šé¢çš„ä¾‹å­ï¼Œä¸Šæ¸¸ <code>upstream</code> æ¨¡æ‹Ÿå‡ºé”™ä¼šå‘å°„ <code>RuntimeException(&quot;always on error!&quot;)</code> äº‹ä»¶ï¼Œç”±è®¢é˜…å…³ç³»å¾—çŸ¥ä¼šè§¦å‘ <code>RepeatWhenObserver</code> çš„ <code>onError()</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-java">@Override
public void onError(Throwable e) {
    DisposableHelper.replace(upstream, null);
    active = false;
    signaller.onNext(e);
}
</code></pre>
<p>å¾ˆæ˜æ˜¾ï¼Œåœ¨è¿™é‡Œæ‹¿åˆ°ä¸Šæ¸¸çš„å¼‚å¸¸ä¿¡æ¯åï¼Œå°†å¼‚å¸¸ä¿¡æ¯é€šè¿‡ <code>signaller</code> æµå‘å°„äº†å‡ºå»ã€‚<code>signaller</code> å³ <code>retryWhen</code> å‚æ•° <code>Function</code> ä¸­ <code>apply()</code> æ–¹æ³•çš„å‚æ•° <code>attempts</code> ã€‚</p>
<p>è¿™é‡Œå…ˆä¸å¿…æ¢ç©¶è°ä¼šè®¢é˜… <code>signaller</code> æµï¼Œæˆ‘ä»¬å…ˆçœ‹ <code>other</code> å‚æ•°ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨ <code>retryWhen</code> ä¸­è¿”å›çš„æµï¼Œå®ƒæ˜¯è¢« <code>InnerRepeatObserver</code> æ‰€è®¢é˜…ç€çš„ï¼Œå¦‚æœæˆ‘ä»¬è¿”å›çš„æµ <code>other</code> å‘å°„äº†ä¸€ä¸ªæ­£å¸¸æ—¶é—´ï¼Œæ¥çœ‹çœ‹ä¼šæ€æ ·ï¼Œå®ƒä¼šè§¦å‘ <code>InnerRepeatObserver</code> çš„ <code>onNext()</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-java">final class InnerRepeatObserver extends AtomicReference&lt;Disposable&gt; implements Observer&lt;Object&gt; {

    private static final long serialVersionUID = 3254781284376480842L;

    @Override
    public void onSubscribe(Disposable d) {
        DisposableHelper.setOnce(this, d);
    }

    @Override
    public void onNext(Object t) {
        innerNext();
    }

    @Override
    public void onError(Throwable e) {
        innerError(e);
    }

    @Override
    public void onComplete() {
        innerComplete();
    }
}
</code></pre>
<p><code>InnerRepeatObserver</code> æ˜¯ <code>RepeatWhenObserver</code> çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œæ‰€ä»¥å®ƒçš„ <code>onNext()</code> ä¸­è°ƒç”¨çš„ <code>innerNext()</code> æ–¹æ³•ä¸º <code>RepeatWhenObserver</code> çš„ï¼š</p>
<pre><code class="language-java">void innerNext() {
    subscribeNext();
}
</code></pre>
<p>è¿™æ ·å°±æ¸…æ¥šäº†ï¼Œé‡Œé¢åˆè°ƒç”¨ <code>RepeatWhenObserver</code> çš„ <code>subscribeNext()</code> æ–¹æ³•ï¼Œä¸Šé¢å·²ç»åˆ†æè¿‡äº†ï¼Œè¯¥æ–¹æ³•ä¼šè®© <code>RepeatWhenObserver</code> è‡ªå·±è®¢é˜…æˆ‘ä»¬çš„åŸå§‹ä¸Šæ¸¸ <code>source</code> ( <code>upstream</code> ) ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬åªè¦è®© <code>other</code> å³æˆ‘ä»¬è¿”å›çš„æµå‘å°„ä¸€æ¬¡ <code>onNext()</code> äº‹ä»¶å³å¯å®Œæˆé‡æ–°è®¢é˜…è¾¾åˆ°é‡è¯•ï¼Œé‚£æ€ä¹ˆè§¦å‘ <code>other</code> å‘å°„äº‹ä»¶å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ä¸Šé¢çš„ <code>signaller</code> ã€‚ä¸Šæ¸¸å‡ºé”™æ—¶ï¼Œä¼šå¯¼è‡´ <code>signaller</code> å°†é”™è¯¯ä¿¡æ¯å½“æˆæ­£å¸¸æ—¶é—´å‘å°„å‡ºå»ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦è®© <code>signaller</code> è§¦å‘ <code>other</code> å³å¯ï¼Œå¯ä»¥ç†è§£ä¸ºåªè¦å°† <code>other</code> å’Œ <code>signaller</code> ç›¸è¿æ¥å³å¯ï¼š</p>
<pre><code class="language-java">upStream.retryWhen(new Function&lt;Observable&lt;Throwable&gt;, ObservableSource&lt;?&gt;&gt;() {
    @Override
    public ObservableSource&lt;?&gt; apply(Observable&lt;Throwable&gt; attempts) throws Exception {
        System.out.println(&quot;retryWhen: apply()&quot;);
        return attempts.flatMap(throwable -&gt; {
            System.out.println(&quot;attempts: flatMap apply() -&gt; &quot; + throwable);
            Thread.sleep(1000);
            return Observable.just(&quot;just retry&quot;);
        });
    }
}).subscribe(downStream);
</code></pre>
<p>åœ¨ <code>attempts.flatMap</code> ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ‹¿åˆ° <code>attempts</code> ä¸­çš„é”™è¯¯ä¿¡æ¯æ¥åˆ¤æ–­æ˜¯å¦é‡è¯•ï¼Œå¦‚æœé‡è¯•åªè¦å‘å°„ä¸€ä¸ªæ­£å¸¸äº‹ä»¶å³å¯ï¼Œå‘ä¸Šé¢çš„ä¾‹å­ä¸€æ ·ï¼Œé‚£ä¸æƒ³é‡è¯•äº†å‘¢ï¼Ÿåªè¦å‘å°„ä¸€ä¸ª <code>onError()</code> é”™è¯¯äº‹ä»¶å³å¯ã€‚ç”±ä¸Šé¢ <code>InnerRepeatObserver</code> æºç å¯ä»¥çœ‹åˆ°å¦‚æœå‘å°„äº†ä¸€ä¸ªé”™è¯¯äº‹ä»¶ï¼Œä¼šè°ƒç”¨ <code>RepeatWhenObserver</code> çš„ <code>innerError()</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-java">void innerError(Throwable ex) {
    DisposableHelper.dispose(upstream);
    HalfSerializer.onError(downstream, ex, this, error);
}
</code></pre>
<pre><code class="language-java">public static void onError(Observer&lt;?&gt; observer, Throwable ex,
        AtomicInteger wip, AtomicThrowable error) {
    if (error.addThrowable(ex)) {
        if (wip.getAndIncrement() == 0) {
            observer.onError(error.terminate());
        }
    } else {
        RxJavaPlugins.onError(ex);
    }
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°å†…éƒ¨ä¼šè°ƒç”¨ <code>downstream</code> çš„ <code>onError()</code> æ–¹æ³•ï¼Œå®Œæˆè½¬å‘æ“ä½œã€‚</p>
<p>è‡³æ­¤å·²ç»åˆ†æå®Œäº†ï¼Œä¸‹é¢é™„ä¸Šæµç¨‹å›¾æ–¹ä¾¿ç†è§£ï¼š</p>
<blockquote>
<p>RWO : <code>RepeatWhenObserver</code></p>
<p>IRO : <code>InnerRepeatObserver</code></p>
</blockquote>
<figure data-type="image" tabindex="1"><img src="http://ww3.sinaimg.cn/large/006tNc79ly1g543bldi53j31a80u0jvr.jpg" alt="" loading="lazy"></figure>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Java åŠ¨æ€ä»£ç†åŠæºç ç®€æ]]></title>
        <id>https://www.imhanjie.com/post/java-dynamic-proxy</id>
        <link href="https://www.imhanjie.com/post/java-dynamic-proxy">
        </link>
        <updated>2019-02-23T06:21:56.000Z</updated>
        <summary type="html"><![CDATA[<p>Android ä¸­çš„ Retrofit æ¡†æ¶ä»¥åŠ Spring AOP çš„å†…éƒ¨å®ç°éƒ½æ˜¯åŸºäº Java åŠ¨æ€ä»£ç†æœºåˆ¶æ¥å®ç°çš„ï¼Œæ‰€ä»¥ç†è§£ Java åŠ¨æ€ä»£ç†æœºåˆ¶æœ‰åŠ©äºæˆ‘ä»¬é˜…è¯»æ¡†æ¶æºç ä»¥åŠç†è§£å…¶å®ç°æ€è·¯ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>Android ä¸­çš„ Retrofit æ¡†æ¶ä»¥åŠ Spring AOP çš„å†…éƒ¨å®ç°éƒ½æ˜¯åŸºäº Java åŠ¨æ€ä»£ç†æœºåˆ¶æ¥å®ç°çš„ï¼Œæ‰€ä»¥ç†è§£ Java åŠ¨æ€ä»£ç†æœºåˆ¶æœ‰åŠ©äºæˆ‘ä»¬é˜…è¯»æ¡†æ¶æºç ä»¥åŠç†è§£å…¶å®ç°æ€è·¯ã€‚</p>
<!--more-->
<p>Java æœ‰ä¸¤ç§ä»£ç†æ–¹å¼ï¼Œä¸€ç§æ˜¯<strong>é™æ€ä»£ç†</strong>ï¼Œå¦å¤–ä¸€ç§å°±æ˜¯æœ¬æ–‡æ‰€ä»‹ç»çš„<strong>åŠ¨æ€ä»£ç†</strong>ã€‚</p>
<h3 id="é™æ€ä»£ç†">é™æ€ä»£ç†</h3>
<p>é™æ€ä»£ç†æ¯”è¾ƒç®€å•ï¼Œé™æ€ä»£ç†ä»£ç†çš„æ˜¯ä¸€ä¸ªç±»ï¼Œä»£ç†ç±»å’Œå§”æ‰˜ç±»ï¼ˆè¢«ä»£ç†ç±»ï¼‰éƒ½å®ç°ç›¸åŒçš„æ¥å£ï¼Œç„¶åä»£ç†ç±»å†…éƒ¨æŒæœ‰å§”æ‰˜ç±»çš„å¼•ç”¨ï¼Œå®¢æˆ·ç«¯åªéœ€è¦ä¸ä»£ç†ç±»æ‰“äº¤é“ï¼Œå®¢æˆ·ç«¯è°ƒç”¨ä»£ç†ç±»çš„æ–¹æ³•æ—¶ï¼Œä»£ç†ç±»å†…éƒ¨å†è°ƒç”¨å§”æ‰˜ç±»çš„æ–¹æ³•ï¼Œä½†åœ¨è°ƒç”¨å§”æ‰˜ç±»æ–¹æ³•çš„å‰åï¼Œä»£ç†ç±»å¯ä»¥æ’å…¥è‡ªå·±çš„ä»£ç ï¼Œæ‰§è¡Œè‡ªå·±çš„é€»è¾‘ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªé™æ€ä»£ç†çš„ç®€å•ä»£ç æ¼”ç¤ºã€‚</p>
<pre><code class="language-java">public interface IAnimal {

    void say(String word);

}
</code></pre>
<pre><code class="language-java">public class Cat implements IAnimal {

    @Override
    public void say(String word) {
        System.out.println(&quot;Cat: say()--&gt;&quot; + word);
    }

}
</code></pre>
<pre><code class="language-java">public class StaticAnimalProxy implements IAnimal{

    private IAnimal animal;

    public StaticAnimalProxy(IAnimal animal) {
        this.animal = animal;
    }

    @Override
    public void say(String word) {
        System.out.println(&quot;é™æ€ä»£ç†å‰ç½®ä»£ç &quot;);
        animal.say(word);
        System.out.println(&quot;é™æ€ä»£ç†åç½®ä»£ç &quot;);
    }

}
</code></pre>
<pre><code class="language-java">StaticAnimalProxy proxy = new StaticAnimalProxy(new Cat());
proxy.say(&quot;hello!&quot;);
</code></pre>
<pre><code>è¾“å‡º:

é™æ€ä»£ç†å‰ç½®ä»£ç 
Cat: say()--&gt;hello!
é™æ€ä»£ç†åç½®ä»£ç 
</code></pre>
<h3 id="åŠ¨æ€ä»£ç†">åŠ¨æ€ä»£ç†</h3>
<p>ä¸Šé¢è¯´åˆ°é™æ€ä»£ç†ä»£ç†çš„æ˜¯ä¸€ä¸ªç±»ï¼ŒåŠ¨æ€ä»£ç†ä»£ç†çš„æ˜¯ä¸€ä¸ªæ¥å£ï¼Œè¦æƒ³å®ç°åŠ¨æ€ä»£ç†ï¼Œå¿…é¡»è¦å®ç° <code>InvocationHandler</code> è¿™ä¸ªæ¥å£ï¼Œè¿™ä¸ªå®ç°ç±»å¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ªè°ƒç”¨å¤„ç†å™¨ (Handler)ï¼Œé€šè¿‡è¿™ä¸ª <code>InvocationHandler</code> çš„å®ç°ç±»å’Œ <code>Proxy</code> ç±»çš„ <code>newProxyInstance()</code> æ–¹æ³•å¯ä»¥åŠ¨æ€ç”Ÿæˆä»»ä½•æ¥å£çš„ä»£ç†ç±»ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå®ç°åŠ¨æ€ä»£ç†çš„ä¾‹å­ã€‚</p>
<pre><code class="language-java">public class DynamicProxyHandler implements InvocationHandler {
    
    // è¢«ä»£ç†çš„å¯¹è±¡
    private Object target;

    public DynamicProxyHandler(Object target) {
        this.target = target;
    }

    @Override
    public Object invoke(Object object, Method method, Object[] args) throws Throwable {
        System.out.println(&quot;åŠ¨æ€ä»£ç†å‰ç½®ä»£ç &quot;);
        // è¿™é‡ŒçœŸæ­£è°ƒç”¨è¢«ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œè¿”å›ç»“æœæ˜¯æ–¹æ³•çš„è¿”å›å€¼ï¼Œåœ¨è¿™è¡Œä»£ç å‰åå¯ä»¥å®ç°é¢å¤–çš„é€»è¾‘ï¼Œå®ç°ä»£ç†åŠŸèƒ½ã€‚
        Object result = method.invoke(target, args);
        System.out.println(&quot;åŠ¨æ€ä»£ç†åç½®ä»£ç &quot;);
        return result;
    }

}
</code></pre>
<pre><code class="language-java">// è¢«ä»£ç†çš„å¯¹è±¡ cat
Cat cat = new Cat();
// åˆ›å»ºè°ƒç”¨å¤„ç†å™¨ï¼Œå°† cat ä½œä¸ºå‚æ•°ä¼ é€’è¿›å»ï¼Œè®©å¤„ç†å™¨æŒæœ‰è¢«ä»£ç†å¯¹è±¡ cat çš„å¼•ç”¨
DynamicProxyHandler proxyHandler = new DynamicProxyHandler(cat);
// å› ä¸º Cat å®ç°äº† IAnimal æ¥å£ï¼Œæ‰€ä»¥è¿™é‡Œç”ŸæˆåŠ¨æ€ç”Ÿæˆä¸€ä¸ª IAnimal çš„ä»£ç†ç±»
IAnimal animal = (IAnimal) Proxy.newProxyInstance(IAnimal.class.getClassLoader(), new Class[]{IAnimal.class}, proxyHandler);
animal.say(&quot;hello!&quot;);
// è¿”å›çš„ animal å®é™…ä¸Šä¸æ˜¯çœŸæ­£çš„ animalï¼Œè€Œæ˜¯ animal çš„ä»£ç†ç±» com.sun.proxy.$Proxy0
System.out.println(animal.getClass().getCanonicalName());
</code></pre>
<pre><code class="language-java">åŠ¨æ€ä»£ç†å‰ç½®ä»£ç 
Cat: say()--&gt;hello!
åŠ¨æ€ä»£ç†åç½®ä»£ç 
com.sun.proxy.$Proxy0
</code></pre>
<h3 id="é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†çš„æ¯”è¾ƒ">é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†çš„æ¯”è¾ƒ</h3>
<ul>
<li>
<p>é™æ€ä»£ç†ä»£ç†çš„æ˜¯ä¸€ä¸ªç±»ï¼ŒåŠ¨æ€ä»£ç†çš„æ˜¯æ¥å£ã€‚</p>
</li>
<li>
<p>é™æ€ä»£ç†ç±»åœ¨ç¨‹åºè¿è¡Œä¹‹å‰ä»£ç†ç±» (.class) å°±å­˜åœ¨äº†ï¼Œè€ŒåŠ¨æ€ä»£ç†æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶é€šè¿‡åå°„æœºåˆ¶åŠ¨æ€ç”Ÿæˆä»£ç†ç±»ã€‚</p>
<blockquote>
<p>StaticAnimalProxy åªèƒ½ä»£ç† IAnimal çš„å®ç°ç±»ã€‚</p>
<p>DynamicProxyHandler å†…éƒ¨ä»£ç†çš„æ˜¯ä¸€ä¸ª Objectï¼Œ<code>Proxy.newProxyInstance</code> æ–¹æ³•å¯ä»¥ä¸ºä»»ä¸€æ¥å£ä»£ç†ç”Ÿæˆä»£ç†ç±»ï¼Œä¸Šé¢çš„ä¾‹å­ä»£ç†çš„æ˜¯ IAnimal çš„ä»£ç†ç±»ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä»£ç†å…¶ä»–æ¥å£ã€‚</p>
</blockquote>
</li>
<li>
<p>ç›¸è¾ƒäºé™æ€ä»£ç†ï¼ŒåŠ¨æ€ä»£ç†çš„ä¼˜ç‚¹æ˜¯å®ç°æ— ä¾µå…¥å¼çš„ä»£ç æ‰©å±•ï¼Œå¯ä»¥åœ¨ä¸ä¿®æ”¹æºç çš„æƒ…å†µä¸‹å»å¢å¼ºä¸€äº›æ–¹æ³•ï¼Œåœ¨æ–¹æ³•çš„å‰ååšè‡ªå·±æƒ³åšçš„äº‹æƒ…ï¼Œæ­¤å¤–ä¹Ÿè¿˜å¯ä»¥å‡å°‘ä»£ç é‡ï¼Œè‹¥ä½¿ç”¨é™æ€ä»£ç†ï¼Œå¦‚æœç±»çš„æ–¹æ³•æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œéœ€è¦æ‰‹å†™å¤§é‡çš„ä»£ç ï¼Œè€ŒåŠ¨æ€ä»£ç†åªéœ€è¦åœ¨ <code>InvocationHandler</code> çš„ <code>invoke()</code> æ–¹æ³•ä¸­å¤„ç†å³å¯ã€‚</p>
</li>
<li>
<p>Java çš„åŠ¨æ€ä»£ç†åªèƒ½ä»£ç†æ¥å£ï¼Œè‹¥è¦åŠ¨æ€ä»£ç†ç±»éœ€è¦ä½¿ç”¨ <code>CGLIB</code> åº“ã€‚</p>
</li>
</ul>
<h3 id="åŠ¨æ€ä»£ç†æºç ç®€æ">åŠ¨æ€ä»£ç†æºç ç®€æ</h3>
<p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°åŠ¨æ€ä»£ç†ç±»æ˜¯ç”± <code>Proxy.newProxyInstance()</code> æ–¹æ³•åŠ¨æ€ç”Ÿæˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ä»çœ‹è¿™ä¸ªæ–¹æ³•å°±è¡Œäº†ã€‚</p>
<pre><code class="language-java">public static Object newProxyInstance(ClassLoader loader,
                                      Class&lt;?&gt;[] interfaces,
                                      InvocationHandler h)
    throws IllegalArgumentException {
    Objects.requireNonNull(h);

    ...

        /*
         * Look up or generate the designated proxy class.
         * ç”Ÿæˆä»£ç†ç±» Class å¯¹è±¡
         */
        Class&lt;?&gt; cl = getProxyClass0(loader, intfs);

    /*
         * Invoke its constructor with the designated invocation handler.
         * åå°„è·å–æ„é€ å™¨ç”Ÿæˆä»£ç†ç±»å®ä¾‹å¯¹è±¡è¿”å›ç»™è°ƒç”¨è€…
         */
    try {
        ...
            final Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);
        final InvocationHandler ih = h;
        ...
            return cons.newInstance(new Object[]{h});
    } catch (IllegalAccessException | InstantiationException e) {
        throw new InternalError(e.toString(), e);
    } catch (InvocationTargetException e) {
        Throwable t = e.getCause();
        if (t instanceof RuntimeException) {
            throw (RuntimeException) t;
        } else {
            throw new InternalError(t.toString(), t);
        }
    } catch (NoSuchMethodException e) {
        throw new InternalError(e.toString(), e);
    }
}
</code></pre>
<p>å†ä¸»è¦çœ‹ <code>getProxyClass0()</code> æ–¹æ³•æ˜¯å¦‚ä½•ç”Ÿæˆä»£ç†ç±» Class å¯¹è±¡çš„ã€‚</p>
<pre><code class="language-java">/**
     * Generate a proxy class.  Must call the checkProxyAccess method
     * to perform permission checks before calling this.
     */
private static Class&lt;?&gt; getProxyClass0(ClassLoader loader,
                                       Class&lt;?&gt;... interfaces) {
    if (interfaces.length &gt; 65535) {
        throw new IllegalArgumentException(&quot;interface limit exceeded&quot;);
    }

    // If the proxy class defined by the given loader implementing
    // the given interfaces exists, this will simply return the cached copy;
    // otherwise, it will create the proxy class via the ProxyClassFactory
    return proxyClassCache.get(loader, interfaces);
}
</code></pre>
<p><code>proxyClassCache</code> ç¼“å­˜äº†ä»£ç†ç±»å¯¹è±¡ï¼Œæ–¹ä¾¿å¤ç”¨ï¼Œ<code>proxyClassCache = new WeakCache&lt;&gt;(new KeyFactory(), new ProxyClassFactory());</code> <code>proxyClassCache</code> æ˜¯ä¸€ä¸ª <code>WeakCache</code> å¯¹è±¡ï¼Œå…¶æ„é€ å™¨çš„ <code>ProxyClassFactory</code> å¯¹è±¡å¾ˆé‡è¦ï¼Œçœ‹åå­—å°±çŸ¥é“äº†ï¼Œè¿™ä¸ªç±»å°±æ˜¯ä¸“é—¨æ¥ç”Ÿæˆä»£ç†ç±»çš„ï¼Œä¸Šé¢çš„ <code>proxyClassCache.get()</code> æ–¹æ³•æœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨äº†å…¶ <code>apply()</code> æ–¹æ³•æ¥ç”Ÿæˆå¹¶è¿”å›çš„ä»£ç†ç±»ï¼Œæ‰€ä»¥ä¸‹é¢æ¥çœ‹ <code>ProxyClassFactory</code> çš„ <code>apply()</code> æ–¹æ³•çš„å†…éƒ¨å®ç°ã€‚</p>
<pre><code class="language-java">@Override
public Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces) {

    Map&lt;Class&lt;?&gt;, Boolean&gt; interfaceSet = new IdentityHashMap&lt;&gt;(interfaces.length);
    for (Class&lt;?&gt; intf : interfaces) {
        /*
             * Verify that the class loader resolves the name of this
             * interface to the same Class object.
             * éªŒè¯ Proxy.newProxyInstance() ä¼ å¯„æ¥çš„ classLoader å’Œ interfaces æ˜¯å¦æœ‰æ•ˆ
             */
        Class&lt;?&gt; interfaceClass = null;
        try {
            interfaceClass = Class.forName(intf.getName(), false, loader);
        } catch (ClassNotFoundException e) {
        }
        if (interfaceClass != intf) {
            throw new IllegalArgumentException(
                intf + &quot; is not visible from class loader&quot;);
        }
        /*
             * Verify that the Class object actually represents an
             * interface.
             * è¿™é‡Œä¸ºäº†éªŒè¯è¦ä»£ç†çš„æ˜¯å¦ä¸ºæ¥å£ï¼Œè‹¥ä¸æ˜¯æ¥å£åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸
             */
        if (!interfaceClass.isInterface()) {
            throw new IllegalArgumentException(
                interfaceClass.getName() + &quot; is not an interface&quot;);
        }
        ...
    }

    ...

        /*
         * Choose a name for the proxy class to generate.
         * ä¸ºä»£ç†ç±»ç”Ÿæˆä¸€ä¸ªåå­—ï¼Œè¿™é‡Œ proxyClassNamePrefix å€¼ä¸º &quot;$Proxy&quot; num ä» 0 å¼€å§‹ï¼Œ
         * æ‰€ä»¥è¿™é‡Œè§£é‡Šäº†ä¸ºä»€ä¹ˆç”Ÿæˆå‡ºæ¥çš„ä»£ç†ç±»åå­—æ—¶ $Proxy0
         */
        long num = nextUniqueNumber.getAndIncrement();
    String proxyName = proxyPkg + proxyClassNamePrefix + num;

    /*
         * Generate the specified proxy class.
         * æœ€ç»ˆç”Ÿæˆä»£ç†ç±» class äºŒçº§åˆ¶æ–‡ä»¶ï¼Œå¹¶å­˜å‚¨æ¥äº†æœ¬åœ°ï¼Œä¹Ÿå°±æ˜¯è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆå‡ºäº† .class æ–‡ä»¶
         */
    byte[] proxyClassFile = ProxyGenerator.generateProxyClass(
        proxyName, interfaces, accessFlags);
    try {
        return defineClass0(loader, proxyName,
                            proxyClassFile, 0, proxyClassFile.length);
    } catch (ClassFormatError e) {
        /*
             * A ClassFormatError here means that (barring bugs in the
             * proxy class generation code) there was some other
             * invalid aspect of the arguments supplied to the proxy
             * class creation (such as virtual machine limitations
             * exceeded).
             */
        throw new IllegalArgumentException(e.toString());
    }
}
</code></pre>
<p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±æ‰‹åŠ¨è°ƒç”¨ <code>ProxyGenerator.generateProxyClass()</code> æ–¹æ³•æ¥ç”Ÿæˆ <code>.class</code> æ–‡ä»¶ï¼Œç„¶ååç¼–è¯‘æŸ¥çœ‹é‡Œé¢çš„å†…å®¹ï¼Œå†…éƒ¨å…¶å®ç”Ÿæˆäº†æ¥å£çš„å„ä¸ªæ–¹æ³•ï¼Œç„¶åå†å„ä¸ªæ–¹æ³•å†…éƒ¨è°ƒç”¨äº† <code>h (InvocationHandler)</code> çš„ <code>invoke(Object proxy, Method method, Object[] args)</code> æ–¹æ³•ï¼Œè½¬åˆ°äº†è°ƒç”¨å±‚ã€‚</p>
<ul>
<li><code>proxy</code> : ä»£ç†ç±»</li>
<li><code>method</code> : è°ƒç”¨çš„æ–¹æ³•ä¿¡æ¯</li>
<li><code>args</code> : è°ƒç”¨è¯¥æ–¹æ³•çš„å‚æ•°</li>
</ul>
<p>ä»¥ä¸Šå°±æ˜¯ Java åŠ¨æ€ä»£ç†çš„ä»‹ç»ä¸åˆ†æï¼ŒSpring çš„ AOP ä»¥åŠ Android Retrofit æ¡†æ¶çš„æ¥å£æ³¨è§£å®ç°å°±æ˜¯åŸºäºåŠ¨æ€ä»£ç†å®ç°çš„ï¼Œå¥½åƒæ˜¯åŸºäº CGLIBï¼Œä¸è¿‡åŸç†å¤§å¤šéƒ½æ˜¯æƒ³é€šçš„ã€‚</p>
<h3 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h3>
<ul>
<li>
<p><a href="https://www.cnblogs.com/flyoung2008/p/3251148.html">å½»åº•ç†è§£JAVAåŠ¨æ€ä»£ç†</a></p>
</li>
<li>
<p><a href="https://juejin.im/post/5c70094051882562a12aec51">æ·±å…¥ç†è§£åŠ¨æ€ä»£ç†</a></p>
</li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Android Jetpack ç³»åˆ—ä¹‹ Lifecycles]]></title>
        <id>https://www.imhanjie.com/post/android-jetpack-lifecycles</id>
        <link href="https://www.imhanjie.com/post/android-jetpack-lifecycles">
        </link>
        <updated>2019-01-16T06:51:51.000Z</updated>
        <summary type="html"><![CDATA[<p>åŸºäºè§‚å¯Ÿè€…æ¨¡å¼çš„ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>åŸºäºè§‚å¯Ÿè€…æ¨¡å¼çš„ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶ã€‚</p>
<!-- more -->
<h3 id="ä»‹ç»">ä»‹ç»</h3>
<p>å¦‚æœä¸€ä¸ªç»„ä»¶ ( ç±» ) éœ€è¦æ„ŸçŸ¥ Activity ( æˆ– Fragment ) çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»¥å‰çš„å†™æ³•æ˜¯åœ¨ Activity çš„å„ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•å†…å»è°ƒç”¨è¿™ä¸ªç»„ä»¶çš„æ–¹æ³•ï¼Œå¦‚æœä¸€ä¸ª Activity å¼•ç”¨äº†å¾ˆå¤šç»„ä»¶ï¼Œå¹¶ä¸”è¿™äº›ç»„ä»¶éƒ½éœ€è¦æ„ŸçŸ¥å…¶ç”Ÿå‘½å‘¨æœŸï¼Œé‚£ä¹ˆ Activity çš„ä»£ç ä¼šè¶Šæ¥è¶Šå¤šä¸æ˜“ç»´æŠ¤ã€‚è¿™æ—¶å€™éœ€è¦ LifeCycleï¼Œä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼ŒActivity ä¸ºè¢«è§‚å¯Ÿè€… ( LifecycleOwner )ï¼Œå„ç»„ä»¶ä¸ºè§‚å¯Ÿè€…( LifecycleObserver ) æ¥æ„ŸçŸ¥ Activity çš„ç”Ÿå‘½å‘¨æœŸï¼Œå½“ Activity ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿå˜åŒ–æ—¶ï¼Œå„ç»„ä»¶å°±å¯ä»¥åœ¨è‡ªå·±å†…éƒ¨æ”¶åˆ°é€šçŸ¥å»æ‰§è¡Œè‡ªå·±çš„é€»è¾‘ï¼Œå°†ä»£ç ä» Activity ä¸­æŒªåˆ°ç»„ä»¶è‡ªå·±å†…éƒ¨ï¼Œä½¿ Activity æ›´ç®€æ´ã€‚</p>
<h3 id="å¯¼å…¥">å¯¼å…¥</h3>
<p>å¯¼å…¥çš„æ–¹å¼å¾ˆç®€å•ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨æœ€æ–°çš„ androix.* åŒ…</p>
<pre><code class="language-groovy">implementation 'androidx.appcompat:appcompat:1.0.2'
</code></pre>
<h3 id="ä½¿ç”¨">ä½¿ç”¨</h3>
<p>å‡å¦‚æœ‰ä¸€ä¸ªè¿™æ ·çš„åœºæ™¯ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª LocationClient ç±» ( æˆ–è€…ç§°ä¹‹ä¸ºç»„ä»¶ ) ï¼Œå®ƒå¯ä»¥è·å–åˆ°æœ€æ–°çš„ä½ç½®ä¿¡æ¯ï¼Œä¸€èˆ¬çš„éœ€è¦åœ¨ Activity çš„ <code>onCreate()</code> æ–¹æ³•ä¸­å»åˆå§‹åŒ–å®ƒï¼Œç„¶ååœ¨ <code>onResume()</code> ä¸­å¯åŠ¨å®šä½æœåŠ¡ï¼Œåœ¨ <code>onPause()</code> ä¸­åœæ­¢å®šä½æœåŠ¡ï¼Œæœ€åå½“ Activity é”€æ¯æ—¶éœ€è¦åœ¨ <code>onDestroy()</code> æ–¹æ³•ä¸­å»åœæ­¢å®šä½ä»¥åŠé‡Šæ”¾ä¸€äº›èµ„æºã€‚</p>
<p>é‚£ä¹ˆä»¥å‰çš„å†™æ³•å¯èƒ½æ˜¯ä»¥ä¸‹è¿™æ ·çš„ï¼š</p>
<pre><code class="language-java">public class LocationClient {

    /**
     * åˆå§‹åŒ–
     */
    public void init() {
        // ...
    }

    /**
     * å¯åŠ¨å®šä½æœåŠ¡
     */
    public void startLocateService() {
        // ...
    }

    /**
     * åœæ­¢å®šä½æœåŠ¡
     */
    public void stopLocateService() {
        // ...
    }

    /**
     * é”€æ¯å¹¶é‡Šæ”¾èµ„æº
     */
    public void destroy() {
        // ...
    }

}
</code></pre>
<pre><code class="language-java">public class LocateActivity extends AppCompatActivity {

    private LocationClient mLocationClient;

    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        mLocationClient = new LocationClient();
        mLocationClient.init();
    }

    @Override
    protected void onResume() {
        super.onResume();
        mLocationClient.startLocateService();
    }

    @Override
    protected void onPause() {
        super.onPause();
        mLocationClient.stopLocateService();
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        mLocationClient.destroy();
    }

}
</code></pre>
<p>ä»¥ä¸Šçš„å†™æ³•çœ‹ç€æ˜¯æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ª Acitivty ä¸­ä½¿ç”¨åˆ°çš„ç»„ä»¶å¾ˆå¤šï¼Œä¾‹å¦‚åœ°å›¾ç»„ä»¶ç­‰ï¼Œé‚£ä¹ˆ Activity çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å†…ä¼šå……æ»¡è¿™æ ·çš„ä»£ç ï¼Œæ˜¾å¾—è‡ƒè‚¿ï¼Œä¸æ˜“ç»´æŠ¤ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹ä¸‹ä½¿ç”¨ Lifecycle çš„å†™æ³•ï¼š</p>
<pre><code class="language-java">public class LocationClient implements LifecycleObserver {

    private LifecycleOwner mLifecycleOwner;

    public LocationClient(LifecycleOwner lifecycleOwner) {
        mLifecycleOwner = lifecycleOwner;
        mLifecycleOwner.getLifecycle().addObserver(this);
    }

    /**
     * åˆå§‹åŒ–
     */
    @OnLifecycleEvent(Lifecycle.Event.ON_CREATE)
    public void init() {
        // ...
    }

    /**
     * å¯åŠ¨å®šä½æœåŠ¡
     */
    @OnLifecycleEvent(Lifecycle.Event.ON_RESUME)
    public void startLocateService() {
        // ...
    }

    /**
     * åœæ­¢å®šä½æœåŠ¡
     */
    @OnLifecycleEvent(Lifecycle.Event.ON_PAUSE)
    public void stopLocateService() {
        // ...
    }

    /**
     * é”€æ¯å¹¶é‡Šæ”¾èµ„æº
     */
    @OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)
    public void destroy() {
        // ...
    }

}
</code></pre>
<pre><code class="language-java">public class LocateActivity extends AppCompatActivity {

    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        new LocationClient(this);
    }

}
</code></pre>
<p>å¯ä»¥å‘ç°ï¼Œä½¿ç”¨ Lifecycle çš„å†™æ³•å’Œä»¥å‰ç›¸æ¯”ï¼ŒActivity ä»£ç å˜å¾—æ›´åŠ ç®€æ´ï¼Œåˆ†æä»£ç ä¹‹å‰å…ˆè§£é‡Šä¸€ä¸‹ 2 ä¸ªç±»ï¼š</p>
<ul>
<li><strong>LifecycleOwner</strong> : è¢«è§‚å¯Ÿçš„å¯¹è±¡</li>
<li><strong>LifecycleObserver</strong> : è§‚å¯Ÿè€…ï¼Œå½“ LifecycleOwner çš„ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿå˜æ›´çš„æ—¶å€™ï¼Œä¼šé€šçŸ¥ç»™å®ƒ</li>
</ul>
<p>æ‰€ä»¥ä»ä»£ç ä¸­å¯ä»¥çœ‹æˆï¼ŒLifecycleOwner è¢«è§‚å¯Ÿçš„å¯¹è±¡å°±æ˜¯è¿™é‡Œçš„ Activityï¼Œè¿™é‡Œæˆ‘ä»¬çš„ Activity æœ€ç»ˆç»§æ‰¿è‡ª ComponentActivityï¼ŒComponentActivity å®ç°äº† LifecycleOwner æ¥å£ï¼š</p>
<pre><code class="language-java">public class ComponentActivity extends Activity
  implements LifecycleOwner, KeyEventDispatcher.Component {
  // ...
}
</code></pre>
<p>æ‰€ä»¥ Activity æ˜¯ä¸€ä¸ªè¢«è§‚å¯Ÿè€…ï¼Œç„¶åæˆ‘ä»¬æ‰‹åŠ¨è®© LocateClient å®ç°äº†LifecycleObserverï¼Œå°†å…¶ä½œä¸ºä¸€ä¸ªè§‚å¯Ÿè€…ï¼Œç„¶åé€šè¿‡ <code>mLifecycleOwner.getLifecycle().addObserver(this);</code> å°† LocateClient ä½œä¸º LocateActivity çš„è§‚å¯Ÿè€…ï¼Œæœ€ååœ¨ LocateClient ä¸­åŸæœ¬éœ€è¦åœ¨ Activity ç”Ÿå‘½å‘¨æœŸä¸­è°ƒç”¨çš„æ–¹æ³•ä¸Šé¢éƒ½åŠ ä¸Šäº†ä¸ä¹‹å¯¹åº”çš„ <code>@OnLifecycleEvent()</code> ç”Ÿå‘½å‘¨æœŸæ³¨è§£ï¼Œè¿™æ ·å½“ Activity çš„ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿå˜æ›´çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨åˆ° LocateClient å¯¹åº”çš„æ–¹æ³•ï¼Œéå¸¸ç®€ä¾¿ï¼ŒActivity æ›´åŠ è½»é‡ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>ä½¿ç”¨ Lifecycle çš„å†™æ³•å…¶å®å°±æ˜¯å°† Activity ä¸­çš„ä»£ç è½¬ç§»åˆ°äº†ç»„ä»¶è‡ªå·±å†…éƒ¨ä¸­ï¼Œä»¥å‰æ˜¯ Activity ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿå˜æ›´æ—¶éœ€è¦ Activity è‡ªå·±ä¸€ä¸ªä¸€ä¸ªçš„å»é€šçŸ¥ç»„ä»¶ï¼Œç°åœ¨æ˜¯ Activity ä¸ç”¨å»ä¸»åŠ¨é€šçŸ¥ç»„ä»¶ï¼Œå¦‚æœä¸€ä¸ªç»„ä»¶æƒ³è¦æ„ŸçŸ¥ Activity çš„ç”Ÿå‘½å‘¨æœŸï¼Œç»„ä»¶è‡ªå·±æ³¨å†Œè¿›æ¥ç›‘å¬ã€‚é‡å¿ƒç”± Activity è½¬ç§»åˆ°äº†ç»„ä»¶ä¸­å»ï¼Œè®© Activity ä¸éœ€è¦å…³å¿ƒç»„ä»¶çš„é€»è¾‘ï¼Œæœ€å Lifecycle é…åˆ MVP é£Ÿç”¨æ›´åŠ ã€‚</p>
<h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<p><a href="https://developer.android.com/topic/libraries/architecture/lifecycle">Handling Lifecycles with Lifecycle-Aware Components</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Android äº‹ä»¶åˆ†å‘æœºåˆ¶]]></title>
        <id>https://www.imhanjie.com/post/android_touch_event_dispatch</id>
        <link href="https://www.imhanjie.com/post/android_touch_event_dispatch">
        </link>
        <updated>2018-11-11T17:15:32.000Z</updated>
        <summary type="html"><![CDATA[<p>ä¹‹å‰ä¸€ç›´å¯¹Androidçš„äº‹ä»¶åˆ†å‘æœºåˆ¶ä¼¼æ‡‚éæ‡‚ï¼Œæ‰€ä»¥æ‹¿èµ·ã€ŒAndroidå¼€å‘è‰ºæœ¯æ¢ç´¢ã€å†³å®šè¿™ä¸¤å¤©å¥½å¥½å­¦ä¹ è¿™æ–¹é¢çš„çŸ¥è¯†é¡ºä¾¿æ€»ç»“ä¸‹ï¼Œä»¥ä¾¿åé¢çš„å¤ä¹ ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>ä¹‹å‰ä¸€ç›´å¯¹Androidçš„äº‹ä»¶åˆ†å‘æœºåˆ¶ä¼¼æ‡‚éæ‡‚ï¼Œæ‰€ä»¥æ‹¿èµ·ã€ŒAndroidå¼€å‘è‰ºæœ¯æ¢ç´¢ã€å†³å®šè¿™ä¸¤å¤©å¥½å¥½å­¦ä¹ è¿™æ–¹é¢çš„çŸ¥è¯†é¡ºä¾¿æ€»ç»“ä¸‹ï¼Œä»¥ä¾¿åé¢çš„å¤ä¹ ã€‚</p>
<!--more-->
<blockquote>
<p>åœ¨çœ‹æºç ä¹‹å‰ï¼Œæˆ‘é¦–å…ˆçœ‹çš„æ˜¯è¿™ç¯‡æ–‡ç« <a href="http://www.jianshu.com/p/2be492c1df96">ã€Œå¯èƒ½æ˜¯è®²è§£Androidäº‹ä»¶åˆ†å‘æœ€å¥½çš„æ–‡ç« ã€</a>ï¼Œè®²å¾—å¾ˆå¥½ï¼Œè™½ç„¶æ–‡ç« å†…æ²¡æœ‰æºç ï¼Œå½“æ—¶çœ‹å®Œåå¯¹çœ‹æºç çš„ç†è§£æœ‰å¾ˆå¤§çš„å¥½å¤„ã€‚<br>
.<br>
è¿™è¾¹æ–‡ç« ä¸»è¦è®²åˆ°äº†ä¸€ä¸ªå¾ˆé‡è¦çš„ç‚¹ï¼šè‹¥å°†å¸ƒå±€çœ‹æˆä¸€ä¸ªæ ‘å½¢ç»“æ„ï¼Œå…ˆæ˜¯</p>
<ul>
<li><code>onInterceptTouchEvent()</code> æ–¹æ³•ç»å†äº†ä»é¡¶å±‚å‘ä¸‹</li>
<li><code>onTouchEvent()</code> æ–¹æ³•ç»å†äº†ä»åº•å±‚å‘ä¸Š(è‹¥æ‰€æœ‰çš„Viewéƒ½ä¸æ‹¦æˆªä¸æ¶ˆè€—çš„æƒ…å†µä¸‹)</li>
<li>è‹¥å…¶ä¸­ä¸€ä¸ª ViewGroup çš„ <code>onInterceptTouchEvent</code>  return true æ‹¦æˆªï¼Œç›´æ¥è·³è½¬åˆ°æ­¤ ViewGroup çš„çˆ¶ç±» View çš„ <code>dispatchOnTouchEvent</code> æ–¹æ³•ä¸­ï¼Œè¡¨ç¤º ViewGroup è‡ªå·±å¤„ç†äº‹ä»¶ã€‚</li>
</ul>
<p>è¿™äº›éƒ½ä¼šåœ¨ä¸‹é¢çš„æºç åˆ†æä¸­èƒ½å¾—åˆ°éªŒè¯</p>
</blockquote>
<h4 id="ç‚¹å‡»äº‹ä»¶çš„åˆ†å‘è¿‡ç¨‹ç”±ä¸‰ä¸ªå¾ˆé‡è¦çš„æ–¹æ³•å®Œæˆ">ç‚¹å‡»äº‹ä»¶çš„åˆ†å‘è¿‡ç¨‹ç”±ä¸‰ä¸ªå¾ˆé‡è¦çš„æ–¹æ³•å®Œæˆï¼š</h4>
<ul>
<li>
<p><code>public boolean dispatchTouchEvent(MotionEvent ev) {}</code><br>
å¦‚æœäº‹ä»¶èƒ½å¤Ÿä¼ é€’ç»™å½“å‰ Viewï¼Œé‚£ä¹ˆæ­¤æ–¹æ³•ä¸€å®šä¼šè¢«è°ƒç”¨ï¼Œè¿”å›ç»“æœå—å½“å‰ View çš„ onTouchEvent å’Œä¸‹çº§ View çš„ dispatchTouchEvent æ–¹æ³•çš„å½±å“ã€‚</p>
</li>
<li>
<p><code>public boolean onInterceptTouchEvent(MotionEvent ev) {}</code><br>
åœ¨ä¸Šé¢çš„ dispatchTouchEvent æ–¹æ³•å†…è°ƒç”¨ï¼Œæ­¤æ–¹æ³•åªæœ‰ ViewGroup æœ‰ï¼ŒView æ²¡æœ‰ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯å¦æ‹¦æˆªæŸä¸ªäº‹ä»¶ï¼Œå¦‚æœå½“å‰ View æ‹¦æˆªäº†æŸä¸ªäº‹ä»¶ï¼Œé‚£ä¹ˆåœ¨åŒä¸€ä¸ªäº‹ä»¶åºåˆ—ä¸­ï¼Œæ­¤æ–¹æ³•ä¸ä¼šè¢«å†æ¬¡è°ƒç”¨ ( åé¢çš„æºç ä¸­å¯ä»¥å¾ˆæ¸…æ¥šçš„éªŒè¯ )ï¼Œè¿”å›ç»“æœè¡¨ç¤ºæ˜¯å¦æ‹¦æˆªå½“å‰äº‹ä»¶ã€‚</p>
</li>
<li>
<p><code>public boolean onTouchEvent(MotionEvent event) {}</code><br>
ä¹Ÿæ˜¯åœ¨ dispatchTouchEvent æ–¹æ³•å†…è°ƒç”¨ï¼Œç”¨æ¥å¤„ç†ç‚¹å‡»äº‹ä»¶ï¼Œè¿”å›ç»“æœè¡¨ç¤ºæ˜¯å¦æ¶ˆè€—å½“å‰äº‹ä»¶ï¼Œå¦‚æœä¸æ¶ˆè€—(return false)ï¼Œåˆ™åœ¨åŒä¸€äº‹ä»¶åºåˆ—ä¸­ï¼Œå½“å‰ View æ— æ³•å†æ¬¡æ¥æ”¶åˆ°äº‹ä»¶ã€‚</p>
</li>
</ul>
<h5 id="ä¸‹é¢æ˜¯ä¸‰è€…å…³ç³»çš„ä¼ªä»£ç ">ä¸‹é¢æ˜¯ä¸‰è€…å…³ç³»çš„ä¼ªä»£ç ï¼š</h5>
<pre><code class="language-java">public boolean dispatchTouchEvent(MotionEvent ev){
	boolean consume = false;
	if(onInterceptTouchEvent(ev)){
		consume = onTouchEvent(ev);
	}else{
		consume = child.dispatchTouchEvent(ev);
	}
	return consume;
}
</code></pre>
<h5 id="å½“ä¸€ä¸ªç‚¹å‡»äº‹ä»¶äº§ç”Ÿåå®ƒçš„ä¼ é€’è¿‡ç¨‹éµå¾ªå¦‚ä¸‹é¡ºåºactivity-window-view">å½“ä¸€ä¸ªç‚¹å‡»äº‹ä»¶äº§ç”Ÿåï¼Œå®ƒçš„ä¼ é€’è¿‡ç¨‹éµå¾ªå¦‚ä¸‹é¡ºåºï¼šActivity -&gt; Window -&gt; View</h5>
<h2 id="activity-window">Activity -&gt; Window</h2>
<p>æºç : Activity#dispatchTouchEvent()</p>
<pre><code class="language-java">public boolean dispatchTouchEvent(MotionEvent ev) {
    if (ev.getAction() == MotionEvent.ACTION_DOWN) {
        onUserInteraction();
    }
    if (getWindow().superDispatchTouchEvent(ev)) {
        return true;
    }
    return onTouchEvent(ev);
}
</code></pre>
<h2 id="window-view">Window -&gt; View</h2>
<p>æºç : PhoneWindow#superDispatchTouchEvent()</p>
<pre><code class="language-java">public boolean superDispatchTouchEvent(MotionEvent ev){
	return mDecor.superDispatchTouchEvent(ev);
}
</code></pre>
<p>è¿™é‡Œç›´æ¥å°†äº‹ä»¶ä¼ ç»™äº† DecorViewï¼Œè€Œ DecorView æ˜¯æˆ‘ä»¬ setContentView çš„çˆ¶å¸ƒå±€ï¼Œè‚¯å®šä¼šä¼ é€’åˆ°æˆ‘ä»¬çš„é¡¶çº§View çš„ã€‚</p>
<h2 id="é¡¶çº§viewå¯¹ç‚¹å‡»äº‹ä»¶çš„åˆ†å‘è¿‡ç¨‹">é¡¶çº§Viewå¯¹ç‚¹å‡»äº‹ä»¶çš„åˆ†å‘è¿‡ç¨‹</h2>
<pre><code class="language-java">
###PART ONE æºç : ViewGroupçš„dispatchTouchEvent()æ–¹æ³•çš„éƒ¨åˆ†ä»£ç ç‰‡æ®µ###

... 

// Check for interception.
final boolean intercepted;
if (actionMasked == MotionEvent.ACTION_DOWN
        || mFirstTouchTarget != null) {
    final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0;
    if (!disallowIntercept) {
        intercepted = onInterceptTouchEvent(ev);
        ev.setAction(action); // restore action in case it was changed
    } else {
        intercepted = false;
    }
} else {
    // There are no touch targets and this action is not an initial down
    // so this view group continues to intercept touches.
    intercepted = true;
}

...


</code></pre>
<ul>
<li>mFirstTouchTarget çš„èµ‹å€¼æƒ…å†µï¼šè‹¥ ViewGroup çš„å­å…ƒç´ æˆåŠŸå¤„ç†æ—¶ï¼ŒmFirstTouchTarget ä¼šè¢«èµ‹å€¼å¹¶æŒ‡å‘å­å…ƒç´ (åé¢ä¼šéªŒè¯)ï¼Œä¸€æ—¦äº‹ä»¶ç”±å½“å‰ ViewGroup å¤„ç†æ—¶ï¼ŒmFirstTouchTarget ä¸º nullï¼Œæ‰€ä»¥åç»­çš„MOVE,UP äº‹ä»¶åˆ°æ¥æ—¶ï¼Œç”±äº <code>actionMasked == MotionEvent.ACTION_DOWN||mFirstTouchTarget != null</code> éƒ½ä¸æˆç«‹ï¼Œæ‰€ä»¥ intercepted = true; æ‰€ä»¥ onInterceptTouchEvent å°†ä¸ä¼šå†è°ƒç”¨åˆ°ï¼ŒéªŒè¯äº†ä¸Šé¢æåˆ°çš„ç»“è®ºã€‚</li>
<li>è¿˜æœ‰ç§ç‰¹æ®Šæƒ…å†µ <code>FLAG_DISALLOW_INTERCEPT</code> è¿™ä¸ªæ ‡è®°ä½ï¼Œè¿™ä¸ªæ ‡è®°ä½å¯ä»¥é€šè¿‡<code>requestDisallowInterceptTouchEvent()</code> è¿™ä¸ªæ–¹æ³•è®¾ç½®ï¼Œä¸€èˆ¬å­å…ƒç´ è°ƒç”¨è¿™ä¸ªæ–¹æ³•åï¼ŒdisallowInterceptä¸ºtrueäº†ï¼Œæ‰€ä»¥çˆ¶Viewçš„ <code>onInterceptTouchEvent()</code> ä¹Ÿæ‰§è¡Œä¸åˆ°äº†ï¼Œæ‰€ä»¥çˆ¶ View å°±ä¸èƒ½æ‹¦æˆªäº‹ä»¶äº†,<strong>ä½†æ˜¯ACTION_DOWN äº‹ä»¶é™¤å¤–</strong>ï¼Œçˆ¶ View è¿˜æ˜¯ä¼šæ‰§è¡Œåˆ° <code>onInterceptTouchEvent()</code>æ¥å†³å®šæ˜¯å¦æ‹¦æˆªçš„ï¼Œå› ä¸ºçœ‹ä¸‹é¢çš„æºç ç‰‡æ®µ,æºç ä¸­å°±ä½äº PART ONE çš„ä¸Šé¢</li>
</ul>
<pre><code class="language-java">###PART TWO æºç : ViewGroupçš„dispatchTouchEvent()æ–¹æ³•çš„éƒ¨åˆ†ä»£ç ç‰‡æ®µ###

...

// Handle an initial down.  å¤„ç†æœ€åˆçš„DOWNäº‹ä»¶
if (actionMasked == MotionEvent.ACTION_DOWN) {
    // Throw away all previous state when starting a new touch gesture.
    // The framework may have dropped the up or cancel event for the previous gesture
    // due to an app switch, ANR, or some other state change.
    cancelAndClearTouchTargets(ev);
    resetTouchState();
}

åé¢ç´§æ¥PART ONEç‰‡æ®µ


</code></pre>
<ul>
<li>åœ¨<code>resetTouchState()</code>çš„æ–¹æ³•å†…å¯¹<code>FLAG_DISALLOW_INTERCEPT</code>çš„æ ‡è®°ä½è¿›è¡Œäº†é‡ç½®ï¼Œæ‰€ä»¥<code>DOWN</code>äº‹ä»¶åˆ°æ¥æ—¶<code>FLAG_DISALLOW_INTERCEPT</code>çš„æ ‡è®°ä½è¿›è¡Œäº†é‡ç½®ï¼Œæ‰€ä»¥éªŒè¯äº†ä¸Šé¢æåˆ°çš„ç‚¹ï¼š<code>requestDisallowInterceptTouchEvent()</code>æ–¹æ³•å¹¶ä¸èƒ½å½±å“åˆ°ViewGroupå¯¹<code>ACTION_DOWN</code>äº‹ä»¶çš„å¤„ç†</li>
</ul>
<h5 id="åˆ°è¿™é‡Œinterceptedå€¼æœ‰ä¸¤ç§ç»“æœè¦ä¹ˆä¸ºfalseè¦ä¹ˆä¸ºtrue">åˆ°è¿™é‡Œï¼Œinterceptedå€¼æœ‰ä¸¤ç§ç»“æœï¼Œè¦ä¹ˆä¸ºfalseï¼Œè¦ä¹ˆä¸ºtrueã€‚</h5>
<h2 id="intercepted-ä¸º-trueçš„æƒ…å†µ">intercepted ä¸º trueçš„æƒ…å†µ</h2>
<p>æ‰€ä»¥ï¼Œå…ˆæ¥çœ‹ä¸ºtrueçš„è¿™ç§æƒ…å†µçš„æºç ï¼Œ<strong>è¿™éƒ¨åˆ†æºç åº”è¯¥æ˜¯è¡¨ç¤ºViewGroupè‡ªå·±å¤„ç†</strong></p>
<p>åœ¨æºç ä¸­è‹¥interceptedä¸ºtruï¼Œåˆ™mFirstTouchTargetä¸ºnull(å‰é¢æè¿‡äº†)ç›´æ¥æ‰§è¡Œåˆ°è¿™é‡Œï¼š</p>
<pre><code class="language-java">###PART THREE æºç : ViewGroupçš„dispatchTouchEvent()æ–¹æ³•çš„éƒ¨åˆ†ä»£ç ç‰‡æ®µ###

// Dispatch to touch targets.
if (mFirstTouchTarget == null) {
    // No touch targets so treat this as an ordinary view.
    handled = dispatchTransformedTouchEvent(ev, canceled, null,
            TouchTarget.ALL_POINTER_IDS);
} else {
	...
}

</code></pre>
<p>è·Ÿè¿›dispatchTransformedTouchEvent()æ–¹æ³•ä»£ç ç‰‡æ®µ</p>
<pre><code class="language-java">...

if (child == null) {
    handled = super.dispatchTouchEvent(event);
} else {
    handled = child.dispatchTouchEvent(event);
}

...
</code></pre>
<p><code>dispatchTransformedTouchEvent()</code>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯childå‚æ•°ï¼Œè¿™é‡Œä¸Šé¢ä¼ äº†nullï¼Œæ‰€ä»¥æ‰§è¡Œ<code>handled = super.dispatchTouchEvent(event)</code>,å› ä¸ºViewGroupç»§æ‰¿è‡ªViewï¼Œæ‰€ä»¥ViewGroupè¦æƒ³è‡ªå·±å¤„ç†äº‹ä»¶ï¼Œè‚¯å®šè¦è°ƒç”¨è‡ªå·±çš„onTouchã€onTouchEventã€onClickæ–¹æ³•ï¼Œæ‰€ä»¥è¦æƒ³ViewGroupå¤„ç†è‡ªå·±ï¼Œå°±è°ƒç”¨çˆ¶ç±»Viewçš„<code>dispatchTouchEvent()</code>æ–¹æ³•ï¼ŒæŠŠè‡ªå·±å½“åšä¸€ä¸ªViewæ¥å¤„ç†è¿™äº›äº‹ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨äº†<code>super.dispatchTouchEvent(event)</code>ï¼Œè‡³äºViewçš„<code>dispatchTouchEvent()</code>äº‹ä»¶æ€ä¹ˆå¤„ç†çš„ï¼Œåé¢ä¼šåˆ†æåˆ°ã€‚</p>
<p>å†çœ‹åˆšæ‰çš„å¦ä¸€ç§ç»“æœï¼Œinterceptedä¸ºfalseï¼Œè¿™ç§ç»“æœçš„ä»£ç ç‰‡æ®µåœ¨PART THREEçš„ä¸Šé¢ï¼Œå› ä¸ºåˆšæ‰interceptedä¸ºtrueï¼Œæ‰€ä»¥è·³è¿‡äº†ä¸‹é¢çš„ä»£ç ï¼Œæ¥çœ‹ä¸‹é¢çš„ä»£ç ç‰‡æ®µ,ä¸‹é¢çš„ä»£ç çš„æ‰§è¡Œæ¡ä»¶æ˜¯**<font color=red>DOWNäº‹ä»¶</font>å¹¶ä¸” interceptedä¸ºfalseï¼Œæ„å‘³ç€ViewGroupä¸æ‹¦æˆªäº‹ä»¶ï¼Œåº”å‘å­å…ƒç´ åˆ†å‘äº‹ä»¶**</p>
<pre><code class="language-java">###PART FOUR æºç : ViewGroupçš„dispatchTouchEvent()æ–¹æ³•çš„éƒ¨åˆ†ä»£ç ç‰‡æ®µ###

final View[] children = mChildren;
for (int i = childrenCount - 1; i &gt;= 0; i--) {
    final int childIndex = customOrder
            ? getChildDrawingOrder(childrenCount, i) : i;
    final View child = (preorderedList == null)
            ? children[childIndex] : preorderedList.get(childIndex);

    // If there is a view that has accessibility focus we want it
    // to get the event first and if not handled we will perform a
    // normal dispatch. We may do a double iteration but this is
    // safer given the timeframe.
    if (childWithAccessibilityFocus != null) {
        if (childWithAccessibilityFocus != child) {
            continue;
        }
        childWithAccessibilityFocus = null;
        i = childrenCount - 1;
    }

    if (!canViewReceivePointerEvents(child)
            || !isTransformedTouchPointInView(x, y, child, null)) {
        ev.setTargetAccessibilityFocus(false);
        continue;
    }

    newTouchTarget = getTouchTarget(child);
    if (newTouchTarget != null) {
        // Child is already receiving touch within its bounds.
        // Give it the new pointer in addition to the ones it is handling.
        newTouchTarget.pointerIdBits |= idBitsToAssign;
        break;
    }
	
    resetCancelNextUpFlag(child);
    if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) {
        // Child wants to receive touch within its bounds.
        mLastTouchDownTime = ev.getDownTime();
        if (preorderedList != null) {
            // childIndex points into presorted list, find original index
            for (int j = 0; j &lt; childrenCount; j++) {
                if (children[childIndex] == mChildren[j]) {
                    mLastTouchDownIndex = j;
                    break;
                }
            }
        } else {
            mLastTouchDownIndex = childIndex;
        }
        mLastTouchDownX = ev.getX();
        mLastTouchDownY = ev.getY();
        newTouchTarget = addTouchTarget(child, idBitsToAssign);
        alreadyDispatchedToNewTouchTarget = true;
        break;
    }

    // The accessibility focus didn't handle the event, so clear
    // the flag and do a normal dispatch to all children.
    ev.setTargetAccessibilityFocus(false);
}

</code></pre>
<p>ä»£ç æ¯”è¾ƒé•¿ï¼Œä¸è¿‡ä¸æ˜¯å¾ˆéš¾ç†è§£ï¼Œå¤§è‡´é€»è¾‘æ˜¯è¿™æ ·çš„ï¼š<br>
éå†ViewGroupçš„æ‰€æœ‰å…ƒç´ ï¼Œå¦‚æœè§¦æ‘¸çš„äº‹ä»¶è½åœ¨éå†åˆ°çš„view(ä½ éƒ½æ²¡touchåˆ°çš„viewï¼Œè¿˜ä¼ é€’åˆ†å‘ç»™ä»–äº‹ä»¶å¹²å˜›ï¼Œå¯¹å§ï¼Ÿ)ï¼Œå¹¶ä¸”å½“å‰éå†åˆ°çš„å…ƒç´ æ­£åœ¨æ’­æ”¾åŠ¨ç”»(æœ‰ç‚¹å¥‡æ€ªï¼Œä¸è¿‡ä¸å½±å“)ï¼Œæ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ï¼Œè¿™ä¸ªå…ƒç´ æ‰èƒ½æ¥æ”¶åˆ°çˆ¶å…ƒç´ ä¼ é€’ç»™ä»–çš„äº‹ä»¶ã€‚è‹¥ä¸¤ä¸ªæ¡ä»¶æœ‰ä¸€ä¸ªä¸æ»¡è¶³å°±continueï¼Œç»§ç»­éå†ã€‚å‡å¦‚éå†åˆ°äº†èƒ½å¤Ÿæ¥æ”¶åˆ°äº‹ä»¶çš„å­å…ƒç´ æ—¶ï¼Œä¾¿ä¼šæ‰§è¡Œåˆ°ä¸Šé¢ä»£ç PART FOURçš„è¿™é‡Œï¼š</p>
<pre><code class="language-java">if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) {
	...
}
</code></pre>
<p>è¿™ä¸ªæ–¹æ³•åˆšæ‰ä¹Ÿçœ‹åˆ°è¿‡äº†ï¼š</p>
<pre><code class="language-java">...

if (child == null) {
    handled = super.dispatchTouchEvent(event);
} else {
    handled = child.dispatchTouchEvent(event);
}

...
</code></pre>
<p>è¿™é‡Œæ³¨æ„äº†ï¼Œåˆšæ‰ViewGroupè‡ªå·±å¤„ç†çš„æ—¶å€™ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°childä¼ çš„æ˜¯nullï¼Œä¸è¿‡ï¼Œè¿™é‡Œæ˜¯ViewGroupä¸å¤„ç†ï¼Œä¼ é€’ç»™å­Viewï¼Œæ‰€ä»¥ç¬¬ä¸‰ä¸ªå‚æ•°childä¼ é€’çš„æ˜¯åˆšæ‰éå†åˆ°çš„å°†è¦æ¥æ”¶åˆ°ä¼ é€’çš„äº‹ä»¶çš„å­å…ƒç´ ï¼Œæ‰€ä»¥æ‰§è¡Œäº†è¿™å¥<code>handled = child.dispatchTouchEvent(event);</code>ï¼Œå¾ˆæ˜æ˜¾ï¼Œæ‰§è¡Œäº†å­å…ƒç´ çš„<code>dispatchTouchEvent()</code>ï¼Œå­å…ƒç´ å¯èƒ½æ˜¯Viewä¹Ÿå¯èƒ½æ˜¯ViewGroupï¼Œå¦‚æœæ˜¯ViewGroupçš„è¯ï¼Œå°±è·Ÿä¸Šé¢åˆ†æçˆ¶å…ƒç´ çš„å¤„ç†è¿‡ç¨‹ä¸€æ ·ï¼Œå¯èƒ½è¿™æ ·å±‚å±‚ä¼ é€’ä¸‹å»....ï¼Œå¦‚æœå­Viewæ˜¯Viewï¼Œé‚£å°±æ›´ç®€å•äº†ï¼Œå› ä¸ºViewçš„<code>dispatchTouchEvent()</code>æ–¹æ³•å†…<code>æ²¡æœ‰onInterceptTouchEvent</code>æ–¹æ³•ï¼Œæ‰€ä»¥<code>dispatchTouchEvent()</code>æ–¹æ³•å¤„ç†è¦ç®€å•çš„å¤šã€‚</p>
<p>æœ€åï¼Œifåˆ¤æ–­çš„<code>dispatchTransformedTouchEvent()</code>ï¼Œä¼šæœ‰ä¸€ä¸ªè¿”å›å€¼ï¼Œçœ‹æºç å‘ç°ï¼Œé‚£ä¸ª<code>dispatchTransformedTouchEvent()</code>çš„è¿”å›å€¼å°±æ˜¯é‚£ä¸ªhandledï¼Œå³<code>child.dispatchTouchEvent(event)</code>çš„è¿”å›å€¼ï¼Œå¦‚æœè¿”å›äº†trueï¼Œè¡¨ç¤ºå­å…ƒç´ æ¥å¤„ç†è¿™ä¸ªäº‹ä»¶äº†ï¼Œå°±ä¼šæ‰§è¡Œåˆ°äº†ifåˆ¤æ–­é‡Œé¢çš„è¿™ä¸€å¥:<code>newTouchTarget = addTouchTarget(child, idBitsToAssign);</code>ï¼Œåœ¨<code>addTouchTarget()</code>ä¸­å®Œæˆäº†å¯¹<code>mFirstTouchTarget</code>çš„èµ‹å€¼(éªŒè¯å‰é¢åå¤æåˆ°çš„ç»“è®º)ï¼Œç„¶åæœ€åä¸€å¥<code>break;</code>ï¼Œæ‰“æ–­forå¾ªç¯ï¼Œå› ä¸ºå·²ç»æœ‰å­å…ƒç´ å¤„ç†äº†ï¼Œæ‰€ä»¥ä¸éœ€è¦éå†äº†ã€‚å¦‚æœ<code>child.dispatchTouchEvent(event)</code>çš„è¿”å›å€¼è¿”å›äº†falseï¼Œè¡¨ç¤ºè¿™ä¸ªå­å…ƒç´ ä¹Ÿä¸å¤„ç†ï¼Œæ‰€ä»¥mFirstTouchTargetæ— æ³•èµ‹å€¼ï¼Œå³ä¸ºnull(éªŒè¯å‰é¢åå¤æåˆ°çš„ç»“è®º)ï¼Œæ¥ç€ç»§ç»­forå¾ªç¯å»éå†ä¸‹ä¸€ä¸ªå­å…ƒç´ ....</p>
<p>åˆšæ‰æåˆ°ï¼Œå¦‚æœéå†åˆ°çš„å­å…ƒç´ æ˜¯ä¸€ä¸ªViewï¼Œå› ä¸ºViewçš„<code>dispatchTouchEvent()</code>å†…æ²¡æœ‰<code>onInterceptTouchEvent</code>æ–¹æ³•ï¼Œæ‰€ä»¥<code>dispatchTouchEvent()</code>æ–¹æ³•å¤„ç†è¦ç®€å•çš„å¤šï¼Œä¸‹é¢ç«‹é©¬åˆ†æViewå¯¹ç‚¹å‡»äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ã€‚</p>
<h2 id="viewå¯¹ç‚¹å‡»äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹">Viewå¯¹ç‚¹å‡»äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹</h2>
<ul>
<li>ä¸‹é¢æ˜¯<strong>Viewçš„dispatchTouchEvent()æ–¹æ³•</strong>éƒ¨åˆ†ä»£ç </li>
</ul>
<pre><code class="language-java">    public boolean dispatchTouchEvent(MotionEvent event) {

		...		

        boolean result = false;

		...

        if (onFilterTouchEventForSecurity(event)) {
            //noinspection SimplifiableIfStatement
            ListenerInfo li = mListenerInfo;
            if (li != null &amp;&amp; li.mOnTouchListener != null
                    &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED
                    &amp;&amp; li.mOnTouchListener.onTouch(this, event)) {
                result = true;
            }

            if (!result &amp;&amp; onTouchEvent(event)) {
                result = true;
            }
        }

		...

        return result;
    }
</code></pre>
<p>å¦‚æœæœ‰è®¾ç½®è¿‡onTouchListenerï¼Œé‚£ä¹ˆ<code>mOnTouchListener.onTouch</code>å°†ä¼šæ‰§è¡Œï¼Œ<strong>å¦‚æœonTouchè¿”å›true</strong>ï¼Œåˆ™resulrä¸ºtrueï¼Œæ‰€ä»¥ä¸‹é¢çš„é‚£ä¸ªifåˆ¤æ–­å†…çš„**<code>onTouchEvent(event)</code>ä¸ä¼šæ‰§è¡Œåˆ°**ã€‚ç›¸åï¼Œ<strong>è‹¥onTouchè¿”å›falseï¼Œ<code>onTouchEvent(event)</code>ä¼šæ‰§è¡Œå¾—åˆ°</strong>ï¼Œæ‰€ä»¥onTouchçš„ä¼˜å…ˆçº§é«˜äºonTouchEventï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯<strong>æ–¹ä¾¿åœ¨å¤–ç•Œå¤„ç†ç‚¹å‡»äº‹ä»¶</strong>ã€‚</p>
<ul>
<li>æ¥ç€åˆ†æonTouchEvent()æ–¹æ³•å†…çš„ä»£ç </li>
</ul>
<pre><code class="language-java">
if ((viewFlags &amp; ENABLED_MASK) == DISABLED) {
    if (action == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != 0) {
        setPressed(false);
    }
    // A disabled view that is clickable still consumes the touch
    // events, it just doesn't respond to them.
    return (((viewFlags &amp; CLICKABLE) == CLICKABLE
            || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)
            || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE);
}

</code></pre>
<p>å…ˆçœ‹å½“Viewå¤„äºä¸å¯ç”¨çš„çŠ¶æ€ä¸‹ç‚¹å‡»äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ï¼Œå¾ˆæ˜¾ç„¶ï¼Œä¸å¯ç”¨çŠ¶æ€ä¸‹çš„Viewç…§æ ·ä¼šæ¶ˆè€—ç‚¹å‡»äº‹ä»¶ï¼Œå°½ç®¡å®ƒçœ‹èµ·æ¥ä¸å¯ç”¨ã€‚</p>
<p>ç»§ç»­çœ‹:</p>
<pre><code class="language-java">if (((viewFlags &amp; CLICKABLE) == CLICKABLE ||
        (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) ||
        (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE) {
    switch (action) {
        case MotionEvent.ACTION_UP:
            boolean prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != 0;
            if ((mPrivateFlags &amp; PFLAG_PRESSED) != 0 || prepressed) {
				
				...
				
                if (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) {
                    // This is a tap, so remove the longpress check
                    removeLongPressCallback();

                    // Only perform take click actions if we were in the pressed state
                    if (!focusTaken) {
                        // Use a Runnable and post this rather than calling
                        // performClick directly. This lets other visual state
                        // of the view update before click actions start.
                        if (mPerformClick == null) {
                            mPerformClick = new PerformClick();
                        }
                        if (!post(mPerformClick)) {
                            performClick();
                        }
                    }
                }

				...

            }

			...

            break;
    }

    return true;
}
</code></pre>
<p>ä»ä¸Šé¢çš„ä»£ç æ¥çœ‹ï¼Œåªè¦Viewçš„<code>CLICKABLE</code>å’Œ<code>LONG CLICKABLE</code>æœ‰ä¸€ä¸ªä¸ºtrueï¼Œé‚£ä¹ˆä»–å°±ä¼šæ¶ˆè€—è¿™ä¸ªäº‹ä»¶ï¼Œå› ä¸ºreturnäº†trueï¼Œä¸ç®¡ä»–æ˜¯ä¸æ˜¯DISABLEçŠ¶æ€ã€‚ç„¶åå½“<code>ACTION_UP</code>è§¦å‘æ—¶ï¼Œä¼šæ‰§è¡Œ<code>performClick()</code>ï¼Œåœ¨<code>performClick()</code>çš„å†…éƒ¨ï¼Œå¦‚æœæœ‰è®¾ç½®onClickListenerï¼Œé‚£ä¹ˆ<code>performClick()</code>æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ä»–çš„onClickæ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-java">public boolean performClick() {
    final boolean result;
    final ListenerInfo li = mListenerInfo;
    if (li != null &amp;&amp; li.mOnClickListener != null) {
        playSoundEffect(SoundEffectConstants.CLICK);
        li.mOnClickListener.onClick(this);
        result = true;
    } else {
        result = false;
    }

    sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED);
    return result;
}
</code></pre>
<p>Viewçš„<code>LONG_CLICKABLE</code>é»˜è®¤æ˜¯falseï¼Œè€Œ<code>CLICKABLE</code>å±æ€§åˆ™è¦çœ‹å…·ä½“çš„Viewäº†ï¼Œä¾‹å¦‚ï¼ŒButtonçš„<code>CLICKABLE</code>é»˜è®¤ä¸ºtrueï¼ŒTextViewçš„<code>CLICKABLE</code>é»˜è®¤ä¸ºfalseï¼Œåªè¦æ‰§è¡Œäº†<code>setOnClickListener()</code>æˆ–è€…<code>setOnLongClickListener()</code>éƒ½ä¼šå°†<code>CLICKABLE</code>æˆ–è€…<code>LONG_CLICKABLE</code>ç½®ä¸ºtrueï¼Œçœ‹æºç å°±çŸ¥é“äº†ï¼š</p>
<pre><code class="language-java">public void setOnClickListener(@Nullable OnClickListener l) {
    if (!isClickable()) {
        setClickable(true);
    }
    getListenerInfo().mOnClickListener = l;
}
</code></pre>
<pre><code class="language-java">public void setOnLongClickListener(@Nullable OnLongClickListener l) {
    if (!isLongClickable()) {
        setLongClickable(true);
    }
    getListenerInfo().mOnLongClickListener = l;
}
</code></pre>
<hr>
<h5 id="ä¸‹ç»“è®ºéƒ½æ˜¯ä¹¦ä¸Šæ€»ç»“çš„">ä¸‹ç»“è®ºéƒ½æ˜¯ä¹¦ä¸Šæ€»ç»“çš„ï¼š</h5>
<ol>
<li>åŒä¸€äº‹ä»¶åºåˆ—æ˜¯æŒ‡ä»æ‰‹æŒ‡æ¥è§¦å±å¹•çš„é‚£ä¸€åˆ»èµ·ï¼Œåˆ°æ‰‹æŒ‡ç¦»å¼€å±å¹•çš„é‚£ä¸€åˆ»ç»“æŸï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„ä¸€ç³»åˆ—äº‹ä»¶ï¼Œè¿™ä¸ªäº‹ä»¶åºåˆ—ä»¥downäº‹ä»¶å¼€å§‹ï¼Œä¸­é—´å«æœ‰æ•°é‡ä¸å®šçš„moveäº‹ä»¶ï¼Œæœ€ç»ˆä»¥upäº‹ä»¶ç»“æŸã€‚</li>
<li>æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªäº‹ä»¶åºåˆ—åªèƒ½è¢«ä¸€ä¸ªViewæ‹¦æˆªä¸”æ¶ˆè€—ã€‚è¿™ä¸€æ¡åŸå› å¯ä»¥å‚è€ƒ(3)ï¼Œå› ä¸ºä¸€æ—¦ä¸€ä¸ªå…ƒç´ æ‹¦æˆªäº†æŸæ­¤äº‹ä»¶ï¼Œé‚£ä¹ˆåŒä¸€äº‹ä»¶åºåˆ—å†…çš„æ‰€æœ‰äº‹ä»¶éƒ½ä¼šç›´æ¥äº¤ç»™å®ƒå¤„ç†ï¼Œå› æ­¤åŒä¸€äº‹ä»¶åºåˆ—ä¸­çš„äº‹ä»¶ä¸èƒ½åˆ†åˆ«ç”±ä¸¤ä¸ªViewåŒæ—¶å¤„ç†ï¼Œä½†æ˜¯é€šè¿‡ç‰¹æ®Šæ‰‹æ®µå¯ä»¥åšåˆ°ï¼Œæ¯”å¦‚ä¸€ä¸ªViewå°†æœ¬è¯¥è‡ªå·±å¤„ç†çš„äº‹ä»¶é€šè¿‡<code>onTouchEvent</code>å¼ºè¡Œä¼ é€’ç»™å…¶ä»–Viewå¤„ç†</li>
<li>æŸä¸ªViewä¸€æ—¦å†³å®šæ‹¦æˆªï¼Œé‚£ä¹ˆè¿™ä¸€ä¸ªäº‹ä»¶åºåˆ—éƒ½åªèƒ½ç”±å®ƒå¤„ç†ï¼ˆå¦‚æœäº‹ä»¶èƒ½å¤Ÿä¼ é€’ç»™ä»–çš„è¯ï¼‰ï¼Œå¹¶ä¸”å®ƒçš„<code>onInterceptTouchEvent</code>ä¸ä¼šå†è¢«è°ƒç”¨ã€‚è¿™æ¡ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯è¯´å½“ä¸€ä¸ªViewå†³å®šæ‹¦æˆªä¸€ä¸ªäº‹ä»¶åï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šæŠŠåŒä¸€äº‹ä»¶åºåˆ—å†…çš„å…¶ä»–æ–¹æ³•éƒ½ç›´æ¥äº¤ç»™ä»–æ¥å¤„ç†ï¼Œå› æ­¤ä¸ä¼šå†è°ƒç”¨è¿™ä¸ªViewçš„<code>onInterceptTouchEvent</code>å»è¯¢é—®å®ƒæ˜¯å¦è¦æ‹¦æˆªäº†</li>
<li>æŸä¸ªViewä¸€æ—¦å¼€å§‹å¤„ç†äº‹ä»¶ï¼Œ<strong>å¦‚æœå®ƒä¸æ¶ˆè€—<code>ACTION_DOWN</code>äº‹ä»¶(<code>onTouchEvent</code>è¿”å›äº†false)ï¼Œé‚£ä¹ˆåŒä¸€äº‹ä»¶åºåˆ—ä¸­çš„å…¶ä»–äº‹ä»¶éƒ½ä¸ä¼šå†äº¤ç»™ä»–æ¥å¤„ç†</strong>ï¼Œå¹¶ä¸”äº‹ä»¶å°†é‡æ–°äº¤ç»™å®ƒçš„çˆ¶å…ƒç´ å¤„ç†ï¼Œå³çˆ¶å…ƒç´ çš„<code>onTouchEvent</code>ä¼šè¢«è°ƒç”¨ã€‚æ„æ€æ˜¯äº‹ä»¶ä¸€æ—¦äº¤ç»™ä¸€ä¸ªViewå¤„ç†ï¼Œé‚£ä¹ˆå®ƒå°±å¿…é¡»æ¶ˆè€—æ‰ï¼Œå¦åˆ™åŒä¸€äº‹ä»¶åºåˆ—ä¸­å‰©ä¸‹çš„äº‹ä»¶å°±ä¸å†äº¤ç»™ä»–æ¥å¤„ç†äº†ã€‚</li>
<li>å¦‚æœViewä¸æ¶ˆè€—é™¤<code>ACTION_DOWN</code>ä»¥å¤–çš„å…¶ä»–äº‹ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªç‚¹å‡»äº‹ä»¶ä¼šæ¶ˆå¤±ï¼Œæ­¤æ—¶çˆ¶å…ƒç´ çš„<code>onTouchEvent</code>å¹¶ä¸ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¸”å½“å‰Viewå¯ä»¥æŒç»­æ”¶åˆ°åç»­çš„ç‚¹å‡»äº‹ä»¶ï¼Œæœ€ç»ˆè¿™äº›æ¶ˆå¤±çš„ç‚¹å‡»äº‹ä»¶ä¼šä¼ é€’ç»™Activityå¤„ç†</li>
<li>ViewGroupé»˜è®¤ä¸æ‹¦æˆªä»»ä½•ç‚¹å‡»äº‹ä»¶ã€‚Androidæºç ä¸­ViewGroupçš„<code>onInterceptTouchEven</code>tæ–¹æ³•é»˜è®¤è¿”å›false</li>
<li>Viewæ²¡æœ‰<code>onInterceptTouchEvent</code>æ–¹æ³•ï¼Œä¸€æ—¦æœ‰ç‚¹å‡»äº‹ä»¶ä¼ é€’ç»™ä»–ï¼Œé‚£ä¹ˆå®ƒçš„<code>onTouchEvent</code>æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨</li>
<li>Viewçš„<code>onTouchEvent</code>é»˜è®¤éƒ½ä¼šæ¶ˆè€—äº‹ä»¶(è¿”å›true)ï¼Œé™¤éå®ƒæ˜¯ä¸å¯ç‚¹å‡»çš„(clickableå’ŒlongClickableåŒæ—¶ä¸ºfalse)ã€‚Viewçš„longClickableå±æ€§é»˜è®¤éƒ½ä¸ºfalseï¼Œclickableå±æ€§è¦åˆ†æƒ…å†µï¼Œä¸å¿…å¤šè¯´</li>
<li>Viewçš„enableå±æ€§ä¸å½±å“onTouchEventçš„é»˜è®¤è¿”å›å€¼ã€‚å“ªæ€•ä¸€ä¸ªViewæ˜¯disableçŠ¶æ€çš„ï¼Œåªè¦å®ƒçš„clickableæˆ–è€…longClickableæœ‰ä¸€ä¸ªä¸ºtrueï¼Œé‚£ä¹ˆå®ƒçš„<code>onTouchEvent</code>å°±è¿”å›true</li>
<li>onClickä¼šå‘ç”Ÿçš„å‰ææ˜¯å½“å‰Viewå¯ç‚¹å‡»çš„ï¼Œå¹¶ä¸”ä»–æ”¶åˆ°äº†downå’Œupäº‹ä»¶</li>
<li>äº‹ä»¶ä¼ é€’è¿‡ç¨‹æ˜¯ç”±å¤–å‘å†…çš„ï¼Œå³äº‹ä»¶æ€»æ˜¯å…ˆä¼ é€’ç»™çˆ¶å…ƒç´ ï¼Œç„¶åå†æœ‰çˆ¶å…ƒç´ åˆ†å‘ç»™å­Viewï¼Œé€šè¿‡<code>requestDisallowInterceptTouchEvent</code>æ–¹æ³•å¯ä»¥åœ¨å­å…ƒç´ ä¸­å¹²é¢„çˆ¶å…ƒç´ çš„äº‹ä»¶åˆ†å‘è¿‡ç¨‹ï¼Œå½“ç„¶<code>ACTION_DOWN</code>ä¸èƒ½å¹²é¢„</li>
</ol>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Android RemoteViews]]></title>
        <id>https://www.imhanjie.com/post/android_remoteviews</id>
        <link href="https://www.imhanjie.com/post/android_remoteviews">
        </link>
        <updated>2018-10-24T14:42:44.000Z</updated>
        <summary type="html"><![CDATA[<p>RemoteViesåœ¨è‡ªå®šä¹‰é€šçŸ¥æ å¸ƒå±€å’Œæ¡Œé¢Widgetçš„å¼€å‘ä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>RemoteViesåœ¨è‡ªå®šä¹‰é€šçŸ¥æ å¸ƒå±€å’Œæ¡Œé¢Widgetçš„å¼€å‘ä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ã€‚</p>
<!--more-->
<p>RemoteViews é¡¾åæ€ä¹‰ï¼Œè¿œç¨‹ Viewï¼ŒRemoteViews è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ª View ç»“æ„ï¼Œä»–å¯ä»¥åœ¨å…¶ä»–è¿›ç¨‹ä¸­æ˜¾ç¤ºï¼Œç”±äºä»–åœ¨å…¶ä»–è¿›ç¨‹ä¸­æ˜¾ç¤ºï¼Œä¸ºäº†èƒ½å¤Ÿæ›´æ–°å®ƒçš„ç•Œé¢ã€‚RemoteViews æä¾›äº†ä¸€ç»„åŸºç¡€çš„æ“ä½œç”¨äºè·¨è¿›ç¨‹æ›´æ–°å®ƒçš„ç•Œé¢ã€‚è‡ªå®šä¹‰é€šçŸ¥æ å¸ƒå±€å’Œæ¡Œé¢Widgetæ›´æ–°ç•Œé¢æ—¶æ— æ³•åƒ Activity é‡Œé¢é‚£æ ·å»ç›´æ¥æ›´æ–° Viewï¼Œè¿™æ˜¯å› ä¸ºä»–ä»¬çš„ç•Œé¢è¿è¡Œåœ¨å…¶ä»–è¿›ç¨‹ä¸­ï¼Œç¡®åˆ‡æ¥è¯´æ˜¯ç³»ç»Ÿçš„ SystemServer è¿›ç¨‹ã€‚ä¸ºäº†æä¾›æ›´æ–°ç•Œé¢ï¼ŒRemoteViews æä¾›äº†ä¸€ç³»åˆ—çš„ set æ–¹æ³•ã€‚</p>
<p>æœ€å¸¸ç”¨çš„æ„é€ æ–¹æ³•ï¼š</p>
<pre><code class="language-java">public RemoteViews(String packageName , int layoutId)
</code></pre>
<p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åŒ…åï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å¸ƒå±€æ–‡ä»¶çš„èµ„æºid;</p>
<p><strong>æ³¨æ„ï¼šRemoteView å¹¶ä¸æ”¯æŒæ‰€æœ‰çš„ Viewï¼Œåªæ”¯æŒéƒ¨åˆ† View ( å› ä¸ºæ›´æ–° UI æ˜¯é€šè¿‡å¤šè¿›ç¨‹çš„ï¼Œæ‰€ä»¥å‡ºäºæ€§èƒ½è€ƒè™‘)</strong></p>
<ul>
<li>ä¸‹é¢åˆ—ä¸¾äº†ä¸€äº›å¸¸ç”¨çš„ set æ–¹æ³•ï¼š</li>
</ul>
<table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>setTextViewText(int viewId, CharSequence text)</td>
<td>è®¾ç½® TextView çš„æ–‡æœ¬</td>
</tr>
<tr>
<td>setTextViewTextSize(int viewId, int units, float size)</td>
<td>è®¾ç½® TextView çš„å­—ä½“å¤§å°</td>
</tr>
<tr>
<td>setTextColor(int viewId, int color)</td>
<td>è®¾ç½® TextView çš„å­—ä½“é¢œè‰²</td>
</tr>
<tr>
<td>setImageViewResource(int viewId, int srcId)</td>
<td>è®¾ç½® ImageView çš„å›¾ç‰‡èµ„æº</td>
</tr>
<tr>
<td>setInt(int viewId, String methodName, int value)</td>
<td>åå°„è°ƒç”¨ View å¯¹è±¡çš„å‚æ•°ç±»å‹ä¸º int çš„æ–¹æ³•</td>
</tr>
<tr>
<td>setLong(int viewId, String methodName, long value)</td>
<td>åå°„è°ƒç”¨ View å¯¹è±¡çš„å‚æ•°ç±»å‹ä¸º long çš„æ–¹æ³•</td>
</tr>
<tr>
<td>setBoolean(int viewId, String methodName, boolean value)</td>
<td>åå°„è°ƒç”¨ View å¯¹è±¡çš„å‚æ•°ç±»å‹ä¸º boolean çš„æ–¹æ³•</td>
</tr>
<tr>
<td>setOnClickPendingIntent(int viewId, PendingIntent pendingIntent)</td>
<td>ä¸º View æ·»åŠ å•å‡»äº‹ä»¶ï¼Œäº‹ä»¶ç±»å‹åªèƒ½ä¸ºPendingIntent</td>
</tr>
</tbody>
</table>
<h3 id="remoteview-çš„å†…éƒ¨æœºåˆ¶">RemoteView çš„å†…éƒ¨æœºåˆ¶</h3>
<ul>
<li>é¦–å…ˆ RemoteViews ä¼šé€šè¿‡ **Binder **ä¼ é€’åˆ° SystemSever è¿›ç¨‹ï¼Œè¿™æ˜¯å› ä¸º RemoteViews å®ç°äº† Parcelable æ¥å£ï¼Œå› æ­¤å¯ä»¥è·¨è¿›ç¨‹ä¼ è¾“</li>
<li>ç³»ç»Ÿä¼šæ ¹æ® RemoteViews ä¸­çš„åŒ…åç­‰ä¿¡æ¯å»å¾—åˆ°è¯¥åº”ç”¨çš„èµ„æºã€‚</li>
<li>é€šè¿‡ LayoutInflater å»åŠ è½½ RemoteViews ä¸­çš„å¸ƒå±€æ–‡ä»¶ã€‚</li>
<li>æ¥ç€ç³»ç»Ÿä¼šå¯¹ View æ‰§è¡Œä¸€ç³»åˆ—ç•Œé¢æ›´æ–°ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡å°±æ˜¯ä¹‹å‰æˆ‘ä»¬é€šè¿‡ set æ–¹æ³•æ¥<strong>æäº¤</strong>çš„ã€‚set æ–¹æ³•å¯¹View çš„æ“ä½œä¸æ˜¯ç«‹åˆ»æ‰§è¡Œçš„ï¼Œåœ¨ RemoteViews å†…éƒ¨ä¼šè®°å½•æ‰€æœ‰çš„æ›´æ–°æ“ä½œï¼Œç­‰åˆ° RemoteViews è¢«åŠ è½½ä»¥åæ‰èƒ½æ‰§è¡Œã€‚</li>
</ul>
<figure data-type="image" tabindex="1"><img src="http://i.imgur.com/YNbpXgK.png" alt="" loading="lazy"></figure>
<p>ç†è®ºä¸Šï¼Œç³»ç»Ÿå®Œå…¨å¯ä»¥é€šè¿‡ Binder å»æ”¯æŒæ‰€æœ‰çš„ View å’Œ View æ“ä½œï¼Œä½†è¿™æ ·åšä»£ä»·å¤ªå¤§ï¼Œå› ä¸º View çš„æ–¹æ³•å¤ªå¤šäº†ï¼Œå¦å¤–å°±æ˜¯å¤§é‡çš„ IPC æ“ä½œä¼šå½±å“æ•ˆç‡ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<strong>ç³»ç»Ÿå¹¶æ²¡æœ‰é€šè¿‡ Binder å»ç›´æ¥æ”¯æŒ View çš„è·¨è¿›ç¨‹è®¿é—®ï¼Œè€Œæ˜¯æä¾›äº†ä¸€ä¸ª Action çš„æ¦‚å¿µï¼ŒAction ä»£è¡¨ä¸€ä¸ª View çš„æ“ä½œï¼ŒAction åŒæ ·å®ç°äº† Parcelable æ¥å£ã€‚ç³»ç»Ÿé¦–å…ˆå°† View æ“ä½œå°è£…åˆ° Action å¯¹è±¡å¹¶å°†è¿™äº›å¯¹è±¡è·¨è¿›ç¨‹ä¼ è¾“åˆ°è¿œç¨‹è¿›ç¨‹ï¼Œæ¥ç€è¿œç¨‹è¿›ç¨‹ä¸­æ‰§è¡Œ Action å¯¹è±¡ä¸­çš„å…·ä½“æ“ä½œã€‚</strong></p>
<p>ä¾‹å¦‚çœ‹ setTextViewText æ–¹æ³•çš„å®ç°ï¼š</p>
<pre><code class="language-java">public void setTextViewText(int viewId, CharSequence text) {
    setCharSequence(viewId, &quot;setText&quot;, text);
}
</code></pre>
<pre><code class="language-java">public void setCharSequence(int viewId, String methodName, CharSequence value) {
    addAction(new ReflectionAction(viewId, methodName, ReflectionAction.CHAR_SEQUENCE, value));
}
</code></pre>
<pre><code class="language-java">private void addAction(Action a) {

	...   

    if (mActions == null) {
        mActions = new ArrayList&lt;Action&gt;();
    }
    mActions.add(a);

    ...
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ° RemoteViews å†…éƒ¨æœ‰ä¸ª mActions æˆå‘˜ï¼Œç”¨äºå­˜å‚¨æ¯æ¬¡ set çš„ Action çš„æ“ä½œã€‚</p>
<pre><code class="language-java">public View apply(Context context, ViewGroup parent, OnClickHandler handler) {
    RemoteViews rvToApply = getRemoteViewsToApply(context);

    View result;
    
	...

    LayoutInflater inflater = (LayoutInflater)
            context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);

    // Clone inflater so we load resources from correct context and
    // we don't add a filter to the static version returned by getSystemService.
    inflater = inflater.cloneInContext(inflationContext);
    inflater.setFilter(this);
    result = inflater.inflate(rvToApply.getLayoutId(), parent, false);

    rvToApply.performApply(result, parent, handler);

    return result;
}
</code></pre>
<pre><code class="language-java">private void performApply(View v, ViewGroup parent, OnClickHandler handler) {
    if (mActions != null) {
        handler = handler == null ? DEFAULT_ON_CLICK_HANDLER : handler;
        final int count = mActions.size();
        for (int i = 0; i &lt; count; i++) {
            Action a = mActions.get(i);
            a.apply(v, parent, handler);
        }
    }
}
</code></pre>
<p>RemoteViews çš„ apply æ–¹æ³•æ˜¯æ¥è¿›è¡Œ View çš„æ›´æ–°æ“ä½œçš„ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒRemoteViews çš„ apply æ–¹æ³•å†…éƒ¨ä¼šéå†è°ƒç”¨æ‰€æœ‰ Action å¯¹è±¡çš„ apply æ–¹æ³•ï¼Œå…·ä½“çš„ View æ›´æ–°æ“ä½œæ˜¯ç”± Action å¯¹è±¡çš„ apply æ–¹æ³•æ¥å®Œæˆçš„ã€‚<br>
è‡³äº apply æ˜¯æ€ä¹ˆè¢«è°ƒç”¨çš„ï¼Œä¾‹å¦‚å½“æˆ‘ä»¬åœ¨å°éƒ¨ä»¶å¼€å‘ä¸­è°ƒç”¨ AppWidgetManager æˆ–è€…é€šçŸ¥æ çš„NotificationManager çš„ notify æ–¹æ³•ï¼Œä»–ä»¬çš„ç¡®æ˜¯é€šè¿‡ RemoteViews çš„ apply ä»¥åŠ reapply æ–¹æ³•æ¥åŠ è½½æˆ–è€…æ›´æ–°ç•Œé¢çš„ã€‚</p>
<p>apply å’Œ reapply çš„åŒºåˆ«åœ¨äºï¼š</p>
<ul>
<li>apply ä¼šåŠ è½½å¸ƒå±€å¹¶æ›´æ–°ç•Œé¢ã€‚</li>
<li>reApply åˆ™åªä¼šæ›´æ–°ç•Œé¢ã€‚</li>
</ul>
<p>é€šçŸ¥æ å’Œæ¡Œé¢å°æ’ä»¶åœ¨åˆå§‹åŒ–ç•Œé¢æ—¶ä¼šè°ƒç”¨ apply æ–¹æ³•ï¼Œè€Œåœ¨åç»­çš„æ›´æ–°ç•Œé¢æ—¶åˆ™ä¼šè°ƒç”¨ reapply æ–¹æ³•ã€‚</p>
<p>ä¸‹é¢çœ‹ä¸€äº› Action çš„å­ç±»çš„å…·ä½“å®ç°ï¼š</p>
<ul>
<li>ReflectionAction</li>
</ul>
<pre><code class="language-java">private final class ReflectionAction extends Action {

	...

    ReflectionAction(int viewId, String methodName, int type, Object value) {
        this.viewId = viewId;
        this.methodName = methodName;
        this.type = type;
        this.value = value;
    }

	...

    @Override
    public void apply(View root, ViewGroup rootParent, OnClickHandler handler) {
        final View view = root.findViewById(viewId);
        if (view == null) return;

        Class&lt;?&gt; param = getParameterType();
        if (param == null) {
            throw new ActionException(&quot;bad type: &quot; + this.type);
        }

        try {
            getMethod(view, this.methodName, param).invoke(view, wrapArg(this.value));
        } catch (ActionException e) {
            throw e;
        } catch (Exception ex) {
            throw new ActionException(ex);
        }
    }
	
	...

}
</code></pre>
<p>ReflectionAction è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªåå°„åŠ¨ä½œã€‚ä½¿ç”¨ ReflectionAction çš„ set æ–¹æ³•æœ‰ï¼šsetTextViewTextã€setBooleanã€setLongã€setDoubleç­‰ç­‰ã€‚</p>
<p>é™¤äº† ReflectionAction è¿˜æœ‰å…¶ä»–çš„ Actionï¼Œä¸‹é¢æ¥çœ‹çœ‹ TextViewSizeActionï¼š</p>
<ul>
<li>TextViewSizeAction</li>
</ul>
<pre><code class="language-java">private class TextViewSizeAction extends Action {
    public TextViewSizeAction(int viewId, int units, float size) {
        this.viewId = viewId;
        this.units = units;
        this.size = size;
    }

	...

    @Override
    public void apply(View root, ViewGroup rootParent, OnClickHandler handler) {
        final TextView target = (TextView) root.findViewById(viewId);
        if (target == null) return;
        target.setTextSize(units, size);
    }

    public String getActionName() {
        return &quot;TextViewSizeAction&quot;;
    }

    int units;
    float size;

    public final static int TAG = 13;
}
</code></pre>
<p>TextViewSizeAction çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä»–ä¹‹æ‰€ä»¥ä¸ç”¨åå°„æ¥å®ç°ï¼Œæ˜¯å› ä¸º setTextSize è¿™ä¸ªæ–¹æ³•æœ‰2ä¸ªå‚æ•°ï¼Œå› æ­¤æ— æ³•å¤ç”¨ ReflectionActionï¼Œå› ä¸º ReflectionAction åå°„è°ƒç”¨åªæœ‰ä¸€ä¸ªå‚æ•°ã€‚</p>
<blockquote>
<p>æ–‡ç« æ•´ç†è‡ªã€ŒAndroidå¼€å‘è‰ºæœ¯æ¢ç´¢ã€</p>
</blockquote>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[MongoDB å¸¸ç”¨å‘½ä»¤æ€»ç»“]]></title>
        <id>https://www.imhanjie.com/post/MongoDB-å¸¸ç”¨å‘½ä»¤æ€»ç»“</id>
        <link href="https://www.imhanjie.com/post/MongoDB-å¸¸ç”¨å‘½ä»¤æ€»ç»“">
        </link>
        <updated>2018-04-26T15:55:02.000Z</updated>
        <summary type="html"><![CDATA[<blockquote>
<p>update : 2018-04-26</p>
</blockquote>
]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p>update : 2018-04-26</p>
</blockquote>
<!--more-->
<table>
<thead>
<tr>
<th style="text-align:center">SQL æœ¯è¯­/æ¦‚å¿µ</th>
<th style="text-align:center">MongoDB æœ¯è¯­/æ¦‚å¿µ</th>
<th style="text-align:center">è§£é‡Š/è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">database</td>
<td style="text-align:center"><strong>database</strong></td>
<td style="text-align:center">æ•°æ®åº“</td>
</tr>
<tr>
<td style="text-align:center">table</td>
<td style="text-align:center"><strong>collection</strong></td>
<td style="text-align:center">æ•°æ®åº“è¡¨/é›†åˆ</td>
</tr>
<tr>
<td style="text-align:center">row</td>
<td style="text-align:center"><strong>document</strong></td>
<td style="text-align:center">æ•°æ®è®°å½•è¡Œ/æ–‡æ¡£</td>
</tr>
<tr>
<td style="text-align:center">column</td>
<td style="text-align:center"><strong>field</strong></td>
<td style="text-align:center">æ•°æ®å­—æ®µ/åŸŸ</td>
</tr>
<tr>
<td style="text-align:center">index</td>
<td style="text-align:center"><strong>index</strong></td>
<td style="text-align:center">ç´¢å¼•</td>
</tr>
<tr>
<td style="text-align:center">table joins</td>
<td style="text-align:center"></td>
<td style="text-align:center">è¡¨è¿æ¥ï¼ŒMongoDB ä¸æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:center">primary key</td>
<td style="text-align:center"><strong>primary key</strong></td>
<td style="text-align:center">ä¸»é”®ï¼ŒMongoDB è‡ªåŠ¨å°† _id å­—æ®µè®¾ç½®ä¸ºä¸»é”®</td>
</tr>
</tbody>
</table>
<h2 id="å¸¸ç”¨å‘½ä»¤">å¸¸ç”¨å‘½ä»¤</h2>
<blockquote>
<p>ä»¥ä¸‹å‘½ä»¤ä»¥ <code>weather</code> æ•°æ®åº“ä¸ºä¾‹</p>
</blockquote>
<h3 id="æ•°æ®åº“">æ•°æ®åº“</h3>
<p><code>use weather</code> ï¼šè¿æ¥åˆ° weather æ•°æ®åº“ï¼ˆä¸å­˜åœ¨è‡ªåŠ¨åˆ›å»ºï¼‰</p>
<p><code>show dbs</code>ï¼šæ˜¾ç¤º Mongo æ‰€æœ‰æ•°æ®åº“</p>
<p><code>db.dropDatabase()</code>ï¼šåˆ é™¤å½“å‰ weather æ•°æ®åº“</p>
<h3 id="é›†åˆè¡¨">é›†åˆï¼ˆè¡¨ï¼‰</h3>
<p><code>db.createCollection(&quot;forecast&quot;)</code>ï¼šåˆ›å»ºä¸€ä¸ª forecast é›†åˆ</p>
<p><code>db.forecast.drop()</code>ï¼šåˆ é™¤ weather æ•°æ®åº“ä¸­çš„ forecast é›†åˆï¼Œå¦‚æœæˆåŠŸåˆ é™¤é€‰å®šé›†åˆï¼Œåˆ™ drop() æ–¹æ³•è¿”å› trueï¼Œå¦åˆ™è¿”å› false</p>
<p><code>show tables / show collections</code>ï¼šæ˜¾ç¤ºæ‰€æœ‰é›†åˆ</p>
<h3 id="æ–‡æ¡£è®°å½•">æ–‡æ¡£ï¼ˆè®°å½•ï¼‰</h3>
<p><code>db.forecast.insert({&quot;type&quot;:&quot;æ™´&quot;})</code>ï¼šæ’å…¥æ–‡æ¡£</p>
<blockquote>
<p>å…¶å® MongoDB ä¸éœ€è¦æ‰‹åŠ¨åˆ›å»ºé›†åˆï¼Œå½“æˆ‘ä»¬æ’å…¥ä¸€æ¡æ–‡æ¡£çš„æ—¶å€™ï¼ŒMongoDB ä¼šè‡ªåŠ¨åˆ›å»ºé›†åˆï¼Œä¾‹å¦‚ <code>db.forecast.insert({&quot;type&quot;:&quot;æ™´&quot;})</code> å³ä½¿ forecast é›†åˆå…ˆå‰æ²¡æœ‰åˆ›å»ºï¼Œæ‰§è¡Œè¯¥æ’å…¥å‘½ä»¤åï¼ŒMongoDB ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬åˆ›å»ºè¯¥é›†åˆï¼Œæ‰€ä»¥ä»è¿™é‡Œæˆ‘å°±æ„Ÿè§‰ MongoDB å¾ˆåƒè¯­è¨€ä¸­çš„ Pythonï¼Œä½¿ç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ - -</p>
<p>æ‰€ä»¥æ‰§è¡Œè¯¥å‘½ä»¤æ—¶ä¸€èˆ¬éœ€è¦é…ç½®ç¬¬äºŒä¸ªå‚æ•°æ¥ä¸ªæ€§åŒ–åˆ›å»ºé›†åˆï¼Œ<code>db.createCollection(name,options)</code> ä¾‹å¦‚æŒ‡å®šæœ‰å…³å†…å­˜å¤§å°åŠç´¢å¼•çš„é€‰é¡¹ï¼Œè¯¦æƒ…æŸ¥çœ‹ï¼š</p>
</blockquote>
<blockquote>
<p>æ’å…¥æ–‡æ¡£ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>db.forecast.save(xxx)</code> å‘½ä»¤ã€‚å¦‚æœä¸æŒ‡å®š <code>_id</code> å­—æ®µ <code>save()</code> æ–¹æ³•ç±»ä¼¼äº <code>insert()</code> æ–¹æ³•ã€‚å¦‚æœæŒ‡å®š <code>_id</code> å­—æ®µï¼Œåˆ™ä¼šæ›´æ–°è¯¥ <code>_id</code> çš„æ•°æ®</p>
</blockquote>
<p><code>db.forecast.find()</code>ï¼šåˆ—å‡ºé›†åˆä¸­çš„æ‰€æœ‰æ–‡æ¡£</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[MVC æ¨¡å¼ä¸ MVP æ¨¡å¼çš„ä¸€äº›æ€è€ƒ]]></title>
        <id>https://www.imhanjie.com/post/mvc-vs-mvp</id>
        <link href="https://www.imhanjie.com/post/mvc-vs-mvp">
        </link>
        <updated>2017-08-06T10:24:01.000Z</updated>
        <summary type="html"><![CDATA[<h2 id="mvc-vs-mvp">MVC vs MVP</h2>
<p>MVP ä¸€ç§ç”±ä¼ ç»Ÿçš„ MVC æ¨¡å¼æ¼”å˜è€Œæ¥å¼€å‘æ¨¡å¼ã€‚MVC å’Œ MVP éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„åœ°æ–¹ï¼Œå°±æ˜¯ Model (M) è´Ÿè´£æ•°æ®çš„å­˜å–ï¼ŒView (V) è´Ÿè´£ç•Œé¢çš„æ˜¾ç¤ºï¼ŒController (C) ä¸ Presenter (P) è´Ÿè´£ä¸šåŠ¡é€»è¾‘çš„å¤„ç†ã€‚ä½†æ˜¯ä¸¤è€…æœ€å¤§çš„ä¸åŒç‚¹å°±æ˜¯ View ä¸ Model ä¹‹é—´çš„äº¤äº’æ–¹å¼ï¼Œåœ¨ MVC ä¸­ Vï¼ŒView å…è®¸å»ç›´æ¥è®¿é—® Modelï¼Œè€Œåœ¨ MVP ä¸­æ˜¯ä¸å¯ä»¥çš„ï¼ŒView ä¸ Model ä¹‹é—´çš„äº¤äº’å®Œå…¨ç”± Presenter æ¥è´Ÿè´£ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<h2 id="mvc-vs-mvp">MVC vs MVP</h2>
<p>MVP ä¸€ç§ç”±ä¼ ç»Ÿçš„ MVC æ¨¡å¼æ¼”å˜è€Œæ¥å¼€å‘æ¨¡å¼ã€‚MVC å’Œ MVP éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„åœ°æ–¹ï¼Œå°±æ˜¯ Model (M) è´Ÿè´£æ•°æ®çš„å­˜å–ï¼ŒView (V) è´Ÿè´£ç•Œé¢çš„æ˜¾ç¤ºï¼ŒController (C) ä¸ Presenter (P) è´Ÿè´£ä¸šåŠ¡é€»è¾‘çš„å¤„ç†ã€‚ä½†æ˜¯ä¸¤è€…æœ€å¤§çš„ä¸åŒç‚¹å°±æ˜¯ View ä¸ Model ä¹‹é—´çš„äº¤äº’æ–¹å¼ï¼Œåœ¨ MVC ä¸­ Vï¼ŒView å…è®¸å»ç›´æ¥è®¿é—® Modelï¼Œè€Œåœ¨ MVP ä¸­æ˜¯ä¸å¯ä»¥çš„ï¼ŒView ä¸ Model ä¹‹é—´çš„äº¤äº’å®Œå…¨ç”± Presenter æ¥è´Ÿè´£ã€‚</p>
<!--more-->
<h2 id="android-ä¸­çš„-mvc">Android ä¸­çš„ MVC</h2>
<p>åœ¨ Android ä¸­ï¼ŒController çš„èŒè´£è½åœ¨äº† Activity ä¸­ï¼Œè€Œ Activity è´Ÿè´£åŠ è½½ XML ä¸­çš„å¸ƒå±€æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šï¼Œå¯¹ View ä¸­çš„æ§ä»¶çš„è®¿é—®ä¹Ÿåœ¨ Activity ä¸­å®Œæˆï¼Œæ‰€ä»¥ Activity å˜å¾— â€œå¾ˆé‡â€ï¼Œé‡åˆ°å¤æ‚çš„ç•Œé¢æ—¶ï¼Œä»£ç é‡åŠ¨è¾„æˆç™¾ä¸Šåƒè¡Œï¼Œéš”æ®µæ—¶é—´å†å»ç»´æŠ¤è¯¥å—ä»£ç æ—¶ï¼Œé‚£ç§ç—›ï¼Œå¯æƒ³è€ŒçŸ¥~</p>
<h2 id="mvp-åœ¨-android-ä¸­çš„åº”ç”¨">MVP åœ¨ Android ä¸­çš„åº”ç”¨</h2>
<ol>
<li>Activity V å±‚åªè´Ÿè´£ç•Œé¢çš„æ˜¾ç¤ºï¼Œä¸šåŠ¡é€»è¾‘äº¤ç»™ P å±‚å¤„ç†ï¼ŒP ä¸ V ç›´æ¥é€šè¿‡æ¥å£é€šä¿¡ã€‚</li>
<li>P å±‚æ”¶åˆ° V å±‚çš„äº¤äº’è¯·æ±‚ï¼Œè´Ÿè´£è°ƒç”¨ M å±‚æ¥å¤„ç†æ•°æ®ï¼Œå¤„ç†å®Œåé€šçŸ¥ V å±‚æ›´æ–°ç•Œé¢ã€‚</li>
<li>P å±‚ä¸ M å±‚ä¹Ÿé€šè¿‡æ¥å£è¿›è¡Œé€šä¿¡ï¼ŒP å±‚å¤„äº V ä¸ M ä¹‹é—´çš„ä¸­ä»‹ï¼Œè´Ÿè´£è°ƒåº¦ V ä¸ Mã€‚</li>
</ol>
<p>MVP æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li>
<p>å®ç° View ä¸ Model çš„è§£è€¦</p>
<p>View ä¸ Model ä¹‹é—´çš„é€šä¿¡éœ€è¦é€šè¿‡ Presenter æ¥å®Œæˆï¼Œä¿®æ”¹ç•Œé¢ä¸å½±å“æ¨¡å‹ï¼Œä¿®æ”¹æ¨¡å‹ä¸å½±å“ç•Œé¢ã€‚</p>
</li>
<li>
<p>é€»è¾‘æ›´æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤</p>
<p>ä½¿ç”¨ MVP åï¼ŒView åªè´Ÿè´£ç•Œé¢çš„æ˜¾ç¤ºï¼Œçœ‹èµ·æ¥éå¸¸å¹²å‡€ï¼Œä¸è‡³äºè¿‡ä¸¤å¤©å†æ¥çœ‹å°±æˆäº† â€œåˆ«äººçš„ä»£ç â€</p>
</li>
<li>
<p>P å±‚ä¸ M å±‚å¤ç”¨</p>
<p>å¦‚æœé¡¹ç›®ä¸­æœ‰ç±»ä¼¼çš„ç•Œé¢ï¼Œå¯ä»¥ç›´æ¥å¤ç”¨ Presenter æˆ–è€… Model å±‚</p>
</li>
<li>
<p>é€‚åˆå¤šäººååŒå¼€å‘</p>
<p>å¦‚æœä¸€ä¸ªé¡µé¢å¤ªå¤æ‚å¯ä»¥å®ç°å¤šäººå…±åŒå¼€å‘ï¼Œå¼€å‘ä¹‹å‰äº‹å…ˆå®šä¹‰å¥½ V ä¸ Pã€P ä¸ V ä¹‹é—´çš„æ¥å£ï¼ˆæ¥å£åæœŸæ ¹æ®å¼€å‘æ¥ä¿®æ”¹ï¼‰ï¼Œç„¶åå¯ä»¥è®©ä¸€ä¸ªäººè´Ÿè´£ç•Œé¢ï¼Œå¦ä¸€ä¸ªäººè´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼Œä¹‹é—´ä½¿ç”¨æ¥å£è¿›è¡Œé€šä¿¡ã€‚</p>
</li>
<li>
<p>å•å…ƒæµ‹è¯•</p>
<p>å¯ä¸ä¾æ‰˜äºç•Œé¢æ¥å•ç‹¬è¿›è¡Œä¸šåŠ¡é€»è¾‘çš„æµ‹è¯•</p>
</li>
</ul>
<p>MVP æ¨¡å¼çš„ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä»£ç é‡å˜å¤šï¼Œéœ€è¦å®šä¹‰å¾ˆå¤šæ¥å£ï¼Œç±»æ–‡ä»¶å¢å¤š</li>
<li>éœ€è¦æ§åˆ¶å¥½ä¸€äº›ç‰¹æ®Šå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œé˜²æ­¢å†…å­˜æ³„æ¼çš„é—®é¢˜</li>
</ul>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>MVP æ¨¡å¼æ²¡æœ‰æ­£ç¡®çš„å†™æ³•ï¼ŒMVP åªæ˜¯ä¸€ä¸ªæ€æƒ³ï¼Œæ ¹æ®éœ€æ±‚é€‚åˆè‡ªå·±é¡¹ç›®æ‰æ˜¯æ­£ç¡®çš„ã€‚é¡µé¢é€»è¾‘è¶Šå¤æ‚ï¼ŒMVP çš„ä¼˜åŠ¿è¶Šæ˜æ˜¾ï¼Œæ‰€ä»¥å¦‚æœé‡åˆ°ç®€å•çš„ç•Œé¢ï¼Œå¯ä»¥ä¸ä½¿ç”¨ MVPã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Android æ¶ˆæ¯å¾ªç¯æœºåˆ¶æ€»ç»“]]></title>
        <id>https://www.imhanjie.com/post/android_handler_summary</id>
        <link href="https://www.imhanjie.com/post/android_handler_summary">
        </link>
        <updated>2017-06-04T06:43:36.000Z</updated>
        <summary type="html"><![CDATA[<p>è¦æƒ³åœ¨ä¸€ä¸ªçº¿ç¨‹è¦æƒ³ä½¿ç”¨æ¶ˆæ¯å¾ªç¯ç³»ç»Ÿï¼Œé€šå¸¸éœ€è¦ï¼š</p>
<pre><code class="language-java">Looper.prepare();
mHandler = new Handler() {...};
Looper.loop();
</code></pre>
]]></summary>
        <content type="html"><![CDATA[<p>è¦æƒ³åœ¨ä¸€ä¸ªçº¿ç¨‹è¦æƒ³ä½¿ç”¨æ¶ˆæ¯å¾ªç¯ç³»ç»Ÿï¼Œé€šå¸¸éœ€è¦ï¼š</p>
<pre><code class="language-java">Looper.prepare();
mHandler = new Handler() {...};
Looper.loop();
</code></pre>
<!--more-->
<p>è€Œåœ¨ UI çº¿ç¨‹ç›´æ¥åˆ›å»º Handler å®ä¾‹å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼ˆé€šè¿‡Handler çš„æ— å‚æ„é€ å‡½æ•°åˆ›å»ºçš„ Handler é»˜è®¤ä¸å½“å‰çº¿ç¨‹çš„ Looper ç»‘å®šï¼‰ï¼Œæ˜¯å› ä¸ºåœ¨ ActivityThread ä¸­çš„ <code>main()</code> æ–¹æ³•ä¸­ï¼Œç³»ç»Ÿå·²ä¸ºæˆ‘ä»¬è‡ªåŠ¨åˆ›å»ºå¥½äº† Looper å¹¶è°ƒç”¨äº† <code>loop()</code> æ–¹æ³•å¼€å¯äº†å¾ªç¯ï¼š</p>
<pre><code class="language-java">public static void main(String[] args) {
    ...
    Looper.prepareMainLooper();
	...
    Looper.loop();
    throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);
}
</code></pre>
<p><code>Looper.prepareMainLooper();</code> å®é™…ä¸Šå°±æ˜¯è°ƒç”¨äº† Looper çš„ prepare() æ–¹æ³•ï¼Œä¹‹æ‰€ä»¥ç³»ç»Ÿå¼„äº†ä¸€ä¸ª <code>prepareMainLooper()</code>æ–¹æ³•æ˜¯å› ä¸ºç³»ç»Ÿåœ¨ç»™ UI çº¿ç¨‹åˆ›å»º Looper å®ä¾‹çš„æ—¶å€™é¡ºä¾¿æŠŠè¿™ä¸ªå®ä¾‹èµ‹å€¼ç»™äº† Looper çš„ä¸€ä¸ªå†…éƒ¨é™æ€å˜é‡ sMainLooperï¼š</p>
<pre><code class="language-java">private static Looper sMainLooper;
</code></pre>
<p>å¹¶ä¸”æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³• <code>getMainLooper()</code> ä¾›å¤–éƒ¨è°ƒç”¨æ¥è·å–è¿™ä¸ª sMainLooperï¼Œæ–¹ä¾¿åœ¨å…¶ä»–çº¿ç¨‹ä¸­å¯éšæ—¶æ‹¿åˆ° UI çº¿ç¨‹çš„ Looperï¼Œä¸€æ—¦æ‹¿åˆ° UI çº¿ç¨‹çš„ Looperï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å…¶ä»–çº¿ç¨‹å¾ˆæ–¹ä¾¿åœ°åˆ›å»ºä¸€ä¸ªä¸ UI çº¿ç¨‹ä¸­çš„ Looper ç›¸å…³è”çš„ Handler äº†ï¼Œä¾‹å¦‚ä¸‹é¢è¿™æ ·ï¼š</p>
<pre><code class="language-Java">Handler handler = new Handler(Looper.getMainLooper){...};
</code></pre>
<h3 id="ä¸€-ä¸€ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ª-looper">ä¸€ã€ä¸€ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ª Looper</h3>
<pre><code class="language-java">private static void prepare(boolean quitAllowed) {
    if (sThreadLocal.get() != null) {
        throw new RuntimeException(&quot;Only one Looper may be created per thread&quot;);
    }
    sThreadLocal.set(new Looper(quitAllowed));
}
</code></pre>
<h3 id="äºŒ-ä¸€ä¸ª-looper-å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª-messagequeue-æ¶ˆæ¯é˜Ÿåˆ—">äºŒã€ä¸€ä¸ª Looper å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª MessageQueue æ¶ˆæ¯é˜Ÿåˆ—</h3>
<pre><code class="language-java">private Looper(boolean quitAllowed) {
    mQueue = new MessageQueue(quitAllowed);
    mThread = Thread.currentThread();
}
</code></pre>
<h3 id="handler-è´Ÿè´£å‘é€-message-æ¶ˆæ¯åˆ°ä¸ä¹‹ç»‘å®šçš„çº¿ç¨‹ä¸­-looper-ä¸­çš„-messagequeue">Handler è´Ÿè´£å‘é€ Message æ¶ˆæ¯åˆ°ä¸ä¹‹ç»‘å®šçš„çº¿ç¨‹ä¸­ Looper ä¸­çš„ MessageQueue</h3>
<p>Handler çš„å„ç§ <code>sendMessage()</code> æ–¹æ³•æœ€åéƒ½ä¼šè¾—è½¬æ¥åˆ° Handler çš„ <code>enqueueMessage()</code> æ–¹æ³•ï¼Œåœ¨å†…éƒ¨è°ƒç”¨äº†ä¸ Handler ç›¸ç»‘å®šçº¿ç¨‹çš„ Looper å†…éƒ¨çš„ MessageQueue çš„ <code>enqueueMessage()</code> æ¥å°†æ¶ˆæ¯æ”¾è¿›æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚</p>
<pre><code class="language-java">private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) {
    msg.target = this;
    if (mAsynchronous) {
        msg.setAsynchronous(true);
    }
    return queue.enqueueMessage(msg, uptimeMillis);
}
</code></pre>
<h3 id="ä¸‰-looper-çš„ä½œç”¨å°±æ˜¯å¾ªç¯å–å‡º-messagequeue-ä¸­çš„-message-å¹¶è¿”äº¤ç»™å‘é€å®ƒçš„-handler-å»å¤„ç†">ä¸‰ã€Looper çš„ä½œç”¨å°±æ˜¯å¾ªç¯å–å‡º MessageQueue ä¸­çš„ Message å¹¶è¿”äº¤ç»™å‘é€å®ƒçš„ Handler å»å¤„ç†</h3>
<p>åœ¨ <code>Looper.loop()</code> è°ƒç”¨åå³å¼€å¯äº†å¾ªç¯ç³»ç»Ÿï¼š</p>
<pre><code class="language-java">public static void loop() {
	...
    for (;;) {
        Message msg = queue.next(); // might block
        if (msg == null) {
            // No message indicates that the message queue is quitting.
            return;
        }
      	...
        try {
            msg.target.dispatchMessage(msg);
        } finally {
            if (traceTag != 0) {
                Trace.traceEnd(traceTag);
            }
        }
		...
    }
}
</code></pre>
<p>Looper ä¸æ–­çš„ä» MessageQueue é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯å¹¶è°ƒç”¨äº†æ¶ˆæ¯çš„ <code>target.dispatchMessage(msg)</code> æ–¹æ³•ï¼ŒMessage çš„ target ä¸€èˆ¬ä¸ºå‘é€æ¶ˆæ¯çš„ Handler (ä¸Šé¢ Handler <code>enqueueMessage()</code>çš„ä»£ç å—ä¸­æœ‰ä½“ç° <code>msg.target = this</code> )ï¼ŒHandler çš„ <code>dispatchMessage()</code> æ–¹æ³•å°±æ˜¯å¯¹æ¶ˆæ¯çš„å¤„ç†äº†ï¼Œ</p>
<pre><code class="language-java">/**
 * Handle system messages here.
 */
public void dispatchMessage(Message msg) {
    if (msg.callback != null) {
        handleCallback(msg);
    } else {
        if (mCallback != null) {
            if (mCallback.handleMessage(msg)) {
                return;
            }
        }
        handleMessage(msg);
    }
}
</code></pre>
<pre><code class="language-java">private static void handleCallback(Message message) {
    message.callback.run();
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¼šä¼˜å…ˆæŠŠæ¶ˆæ¯äº¤ç»™ Message çš„ callback (ä¸€ä¸ª Runnable) çš„ <code>run()</code> æ–¹æ³•å¤„ç†ï¼Œå¦‚æœ callback ä¸ºç©ºå°±ä¼šå†å°è¯•ç»™ Handler çš„ callback(mCallback) å¤„ç†ï¼Œå¦‚æœ Handler çš„ callback ä¹Ÿä¸ºç©ºï¼Œå°±ä¼šç»™ Handler æˆ‘ä»¬ç†ŸçŸ¥çš„ <code>handleMessage()</code> æ–¹æ³•å¤„ç†ã€‚</p>
<h3 id="å››-ä¸€ä¸ªçº¿ç¨‹ä¸­å¯ä»¥æœ‰å¤šä¸ª-handlerä½†ä¸€ä¸ª-handler-åªèƒ½ä¸ä¸€ä¸ª-looper-ç»‘å®š">å››ã€ä¸€ä¸ªçº¿ç¨‹ä¸­å¯ä»¥æœ‰å¤šä¸ª Handlerï¼Œä½†ä¸€ä¸ª Handler åªèƒ½ä¸ä¸€ä¸ª Looper ç»‘å®š</h3>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Clean Code - æœ‰æ„ä¹‰çš„å‘½å]]></title>
        <id>https://www.imhanjie.com/post/clean_code_name</id>
        <link href="https://www.imhanjie.com/post/clean_code_name">
        </link>
        <updated>2017-05-08T14:45:10.000Z</updated>
        <content type="html"><![CDATA[<h4 id="1-å¦‚æœåç§°éœ€è¦æ³¨é‡Šæ¥è¡¥å……é‚£å°±ä¸ç®—æ˜¯åå‰¯å…¶å®">1. å¦‚æœåç§°éœ€è¦æ³¨é‡Šæ¥è¡¥å……ï¼Œé‚£å°±ä¸ç®—æ˜¯åå‰¯å…¶å®ã€‚</h4>
<h4 id="2-åºŸè¯éƒ½æ˜¯å†—ä½™">2. åºŸè¯éƒ½æ˜¯å†—ä½™ã€‚</h4>
<h4 id="3-variable-ä¸€è¯æ°¸è¿œä¸åº”è¯¥å‡ºç°åœ¨å˜é‡ä¸­">3. Variable ä¸€è¯æ°¸è¿œä¸åº”è¯¥å‡ºç°åœ¨å˜é‡ä¸­ã€‚</h4>
<h4 id="4-table-ä¸€è¯æ°¸è¿œä¸åº”è¯¥å‡ºç°åœ¨è¡¨åä¸­">4. Table ä¸€è¯æ°¸è¿œä¸åº”è¯¥å‡ºç°åœ¨è¡¨åä¸­ã€‚</h4>
<h4 id="5-å¦‚æœåç§°è¯»ä¸å‡ºæ¥è®¨è®ºçš„æ—¶å€™å°±ä¼šåƒä¸ªå‚»é¸Ÿ">5. å¦‚æœåç§°è¯»ä¸å‡ºæ¥ï¼Œè®¨è®ºçš„æ—¶å€™å°±ä¼šåƒä¸ªå‚»é¸Ÿã€‚</h4>
<h4 id="6-é•¿åç§°èƒœäºçŸ­åç§°æœå¾—åˆ°çš„åç§°èƒœäºç”¨è‡ªé€ åç§°">6. é•¿åç§°èƒœäºçŸ­åç§°ï¼Œæœå¾—åˆ°çš„åç§°èƒœäºç”¨è‡ªé€ åç§°ã€‚</h4>
]]></content>
    </entry>
</feed>